<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  <title>Housekeeping Inventory &amp; Stock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .main-wrapper {
      height: 100%;
      width: 100%;
      background: linear-gradient(135deg, #0b1a33 0%, #00112a 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-y: scroll;
      overflow-x: hidden;
      position: relative;
    }

    .gold-text {
      color: #d4af37;
    }

    .premium-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2.5rem;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.15);
      position: relative;
    }

    .premium-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 40px rgba(212, 175, 55, 0.35);
      border-color: #f4cf5c;
    }

    .card-emoji {
      font-size: 4rem;
      margin-bottom: 1rem;
      display: block;
      text-align: center;
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #d4af37;
      text-align: center;
      letter-spacing: 0.5px;
    }

    .main-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #d4af37;
      text-align: center;
      margin-bottom: 3rem;
      letter-spacing: 1px;
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }

    .footer-text {
      text-align: center;
      color: #d4af37;
      opacity: 0.7;
      padding: 2rem;
      font-size: 0.9rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }

    .footer-version {
      font-size: 0.85rem;
      color: #f4e4a8;
      opacity: 0.8;
    }

    .build-badge {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: rgba(8, 15, 34, 0.9);
      border: 1px solid rgba(212, 175, 55, 0.4);
      color: #f4e4a8;
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 9999;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .notification-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      .notification-section-title {
        margin: 1rem 0 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: #d4af37;
        opacity: 0.9;
      }
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .back-button {
      background: #0d1b2a;
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      margin-bottom: 2rem;
      display: inline-block;
    }

    .back-button:hover {
      background: rgba(212, 175, 55, 0.2);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .hidden {
      display: none;
    }

    .pin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 2rem;
    }

    .pin-panel {
      width: 100%;
      max-width: 380px;
      background: rgba(13, 27, 42, 0.95);
      border: 2px solid #d4af37;
      border-radius: 18px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
    }

    .pin-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 0.5rem;
    }

    .pin-subtitle {
      color: #d4af37;
      opacity: 0.8;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    .pin-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 0.85rem;
      text-align: center;
      font-size: 1.3rem;
      letter-spacing: 0.4rem;
      color: #fff;
      margin-bottom: 1rem;
    }

    .pin-error {
      color: #ff6b6b;
      font-size: 0.9rem;
      min-height: 1.2rem;
      margin-bottom: 1rem;
    }

    .pin-button {
      width: 100%;
      background: #28a745;
      color: #fff;
      border: none;
      padding: 0.85rem 1rem;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pin-button:hover {
      background: #218838;
    }

    .expiration-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .date-header {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .date-display {
      font-size: 1.5rem;
      font-weight: 600;
      color: #d4af37;
    }

    .stats-container {
      display: flex;
      gap: 2rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      color: #d4af37;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      color: #d4af37;
      font-size: 2rem;
      font-weight: 700;
    }

    .add-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 2rem;
    }

    .add-button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }

    .add-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .form-container {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      color: #d4af37;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input, .form-select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #d4af37;
      border-radius: 6px;
      padding: 0.75rem;
      color: white;
      font-size: 1rem;
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .form-select {
      cursor: pointer;
    }

    .form-select option {
      background: #0d1b2a;
      color: white;
      padding: 0.5rem;
    }

    .form-select optgroup {
      background: #1a2942;
      color: #d4af37;
      font-weight: 700;
      font-style: normal;
    }

    .form-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-submit {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-submit:hover {
      background: #218838;
    }

    .btn-submit:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .btn-cancel {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      border: 2px solid #d4af37;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-cancel:hover {
      background: rgba(212, 175, 55, 0.3);
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 16px;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .empty-title {
      font-size: 1.5rem;
      color: #d4af37;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .empty-subtitle {
      color: #d4af37;
      opacity: 0.7;
      font-size: 1rem;
    }

    .items-grid {
      display: grid;
      gap: 1.5rem;
    }

    .item-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1.5rem;
      transition: all 0.3s ease;
    }

    .item-card:hover {
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
    }

    .storage-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .storage-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (min-width: 768px) {
      .storage-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (min-width: 1024px) {
      .storage-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }

    .storage-card {
      background: linear-gradient(160deg, rgba(16, 27, 54, 0.95), rgba(7, 14, 32, 0.98));
      border: 1.5px solid rgba(212, 175, 55, 0.35);
      border-radius: 16px;
      padding: 1.35rem 1.1rem;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      text-align: center;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: 0 10px 28px rgba(2, 6, 15, 0.45);
    }

    .storage-card.has-items {
      border-color: rgba(212, 175, 55, 0.75);
    }

    .storage-card:hover {
      border-color: #d4af37;
      transform: translateY(-6px);
      box-shadow: 0 16px 32px rgba(212, 175, 55, 0.18);
    }

    .storage-card-v2 {
      background: linear-gradient(165deg, rgba(18, 30, 58, 0.98), rgba(6, 12, 28, 0.98)) !important;
      border: 2px solid rgba(212, 175, 55, 0.55) !important;
      border-radius: 18px !important;
      min-height: 150px !important;
      box-shadow: 0 18px 36px rgba(2, 6, 15, 0.5) !important;
    }

    .storage-icon {
      font-size: 2.6rem;
      margin-bottom: 0.35rem;
    }

    .storage-id {
      font-size: 1.6rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 0.35rem;
      letter-spacing: 0.4px;
    }

    .storage-status {
      font-size: 0.875rem;
      color: #f4e4a8;
      margin-top: 0.25rem;
    }

    .storage-preview {
      font-size: 0.95rem;
      color: #f4e4a8;
      font-style: normal;
      font-weight: 600;
      opacity: 0.85;
      margin-top: 0.5rem;
    }

    .storage-preview.prominent {
      font-size: 1.1rem;
      font-weight: 700;
      color: #f7e7b7;
      opacity: 1;
    }

    .item-main {
      flex: 1;
      display: flex;
      gap: 1rem;
    }

    .item-icon {
      font-size: 2.5rem;
    }

    .item-content {
      flex: 1;
    }

    .item-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 0.75rem;
    }

    .item-details {
      display: grid;
      gap: 0.5rem;
    }

    .item-detail {
      color: #d4af37;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .item-detail strong {
      opacity: 1;
      font-weight: 600;
    }

    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .btn-archive {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .btn-archive:hover {
      background: rgba(212, 175, 55, 0.4);
      transform: scale(1.05);
    }

    .btn-delete {
      background: rgba(220, 53, 69, 0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .btn-delete:hover {
      background: rgba(220, 53, 69, 0.4);
      transform: scale(1.05);
    }

    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .date-group {
      margin-bottom: 2rem;
    }

    .date-banner {
      background: rgba(13, 27, 42, 0.9);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .date-banner:hover {
      background: rgba(13, 27, 42, 1);
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
    }

    .date-banner-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .expand-arrow {
      color: #d4af37;
      font-size: 1.2rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.2em;
      height: 1.2em;
      line-height: 1;
      transform-origin: center center;
      transition: transform 0.3s ease;
    }

    .expand-arrow.expanded {
      transform: rotate(90deg);
    }

    .date-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #d4af37;
    }

    .item-count-badge {
      background: rgba(212, 175, 55, 0.3);
      color: #d4af37;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .btn-delete-all {
      background: rgba(220, 53, 69, 0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-delete-all:hover {
      background: rgba(220, 53, 69, 0.4);
      transform: scale(1.05);
    }

    .notifications-list {
      display: grid;
      gap: 1rem;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .notifications-list.expanded {
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .notification-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .notification-card:hover {
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
    }

    .notification-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .notification-icon {
      font-size: 2rem;
    }

    .notification-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #d4af37;
    }

    .notification-body {
      margin-bottom: 1rem;
      color: #d4af37;
    }

    .notification-detail {
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .notification-detail strong {
      font-weight: 600;
      opacity: 1;
    }

    .order-summary {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .order-summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .order-summary-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #d4af37;
      letter-spacing: 0.4px;
    }

    .order-summary-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .order-summary-btn {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .order-summary-btn:hover {
      background: rgba(212, 175, 55, 0.3);
    }

    .order-summary-btn.primary {
      background: #28a745;
      border-color: #28a745;
      color: white;
    }

    .order-summary-list {
      display: grid;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    .order-summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #d4af37;
      font-size: 1rem;
    }

    .order-summary-qty {
      font-weight: 700;
      color: #f5c2c7;
    }

    .order-summary-empty {
      margin-top: 0.75rem;
      color: #d4af37;
      opacity: 0.8;
      font-size: 0.95rem;
    }

    .order-summary.collapsed .order-summary-list,
    .order-summary.collapsed .order-summary-empty {
      display: none;
    }

    .order-qty-badge {
      display: inline-block;
      margin-left: 0.35rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.6);
      color: #f5c2c7;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .notification-actions {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .btn-delete-single {
      background: rgba(220, 53, 69, 0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-delete-single:hover {
      background: rgba(220, 53, 69, 0.4);
      transform: scale(1.02);
    }

    .notification-footer {
      padding-top: 1rem;
      border-top: 1px solid rgba(212, 175, 55, 0.3);
      font-size: 0.9rem;
      color: #d4af37;
      opacity: 0.8;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: #0d1b2a;
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 1rem;
    }

    .modal-text {
      color: #d4af37;
      margin-bottom: 1.5rem;
      opacity: 0.9;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-modal-cancel {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-modal-cancel:hover {
      background: rgba(212, 175, 55, 0.3);
    }

    .btn-modal-confirm {
      background: #dc3545;
      border: 2px solid #dc3545;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-modal-confirm:hover {
      background: #c82333;
    }

    @media (max-width: 768px) {
      .date-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-container {
        width: 100%;
        justify-content: space-around;
      }

      .item-card {
        flex-direction: column;
      }

      .item-actions {
        flex-direction: row;
        width: 100%;
      }

      .btn-archive, .btn-delete {
        flex: 1;
      }
    }

    .archive-section {
      margin-bottom: 3rem;
    }

    .archive-section-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 2rem;
      text-align: center;
    }

    .archive-divider {
      height: 2px;
      background: linear-gradient(to right, transparent, #d4af37, transparent);
      margin: 3rem 0;
    }

    .archive-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1.5rem;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .archive-card.expired-item {
      border-left: 5px solid #dc3545;
    }

    .archive-card:hover {
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
    }

    .archive-item-main {
      flex: 1;
      display: flex;
      gap: 1rem;
    }

    .archive-item-icon {
      font-size: 2.5rem;
    }

    .archive-item-content {
      flex: 1;
    }

    .archive-item-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 0.75rem;
    }

    .archive-item-details {
      display: grid;
      gap: 0.5rem;
    }

    .archive-item-detail {
      color: #d4af37;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .archive-item-detail strong {
      opacity: 1;
      font-weight: 600;
    }

    .date-banner-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-save-pdf, .btn-print-pdf {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-size: 0.9rem;
    }

    .btn-save-pdf:hover, .btn-print-pdf:hover {
      background: rgba(212, 175, 55, 0.4);
      transform: scale(1.05);
    }

    .inspirational-quote {
      text-align: center;
      font-style: italic;
      color: #d4af37;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    /* Stock Counter Styles */
    .stock-counter-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .progress-indicator {
      text-align: center;
      color: #d4af37;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 2rem;
    }

    .counter-panel {
      background: rgba(13, 27, 42, 0.9);
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 8px 32px rgba(212, 175, 55, 0.2);
    }

    .display-area {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 0.75rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .display-area:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: #f4cf5c;
    }

    .display-number {
      font-size: 2rem;
      font-weight: 700;
      color: #d4af37;
    }

    .display-hint {
      font-size: 0.8rem;
      color: #d4af37;
      opacity: 0.7;
    }

    .number-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .num-button {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      font-size: 2rem;
      font-weight: 700;
      padding: 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .num-button:hover {
      background: rgba(212, 175, 55, 0.4);
      transform: scale(1.05);
    }

    .num-button:active {
      transform: scale(0.95);
    }

    .num-button.wide {
      grid-column: span 2;
    }

    .quick-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-btn {
      flex: 1;
      background: rgba(40, 167, 69, 0.2);
      border: 2px solid #28a745;
      color: #28a745;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-btn:hover {
      background: rgba(40, 167, 69, 0.4);
      transform: scale(1.05);
    }

    .save-item-btn {
      background: #28a745;
      border: 2px solid #28a745;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      padding: 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .save-item-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(40, 167, 69, 0.4);
    }

    .save-item-btn:disabled {
      background: #6c757d;
      border-color: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .dropdown-group {
      margin-bottom: 1.5rem;
    }

    .equipment-tab {
      background: rgba(212, 175, 55, 0.2);
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .equipment-tab:hover {
      background: rgba(212, 175, 55, 0.3);
    }

    .equipment-tab.active {
      background: #d4af37;
      color: #0d1b2a;
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
    }

    .equipment-category-section {
      margin-bottom: 2rem;
    }

    .category-banner {
      background: rgba(13, 27, 42, 0.9);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .category-banner:hover {
      background: rgba(13, 27, 42, 1);
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
    }

    .category-banner-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .category-icon {
      font-size: 1.5rem;
    }

    .category-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #d4af37;
    }

    .equipment-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #d4af37;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .equipment-card:hover {
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
    }

    .equipment-card.status-broken {
      border-left: 5px solid #dc3545;
    }

    .equipment-card.status-maintenance {
      border-left: 5px solid #ffc107;
    }

    .equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .equipment-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 0.5rem;
    }

    .equipment-status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .equipment-status-badge.working {
      background: rgba(40, 167, 69, 0.3);
      color: #28a745;
      border: 1px solid #28a745;
    }

    .equipment-status-badge.broken {
      background: rgba(220, 53, 69, 0.3);
      color: #dc3545;
      border: 1px solid #dc3545;
    }

    .equipment-status-badge.maintenance {
      background: rgba(255, 193, 7, 0.3);
      color: #ffc107;
      border: 1px solid #ffc107;
    }

    .equipment-details {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .equipment-detail {
      color: #d4af37;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .equipment-detail strong {
      opacity: 1;
      font-weight: 600;
    }

    .equipment-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn-report-issue {
      background: rgba(220, 53, 69, 0.2);
      border: 2px solid #dc3545;
      color: #dc3545;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-report-issue:hover {
      background: rgba(220, 53, 69, 0.4);
      transform: scale(1.05);
    }

    .btn-mark-working {
      background: rgba(40, 167, 69, 0.2);
      border: 2px solid #28a745;
      color: #28a745;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-mark-working:hover {
      background: rgba(40, 167, 69, 0.4);
      transform: scale(1.05);
    }

    .issue-card {
      background: rgba(13, 27, 42, 0.7);
      border: 2px solid #dc3545;
      border-left: 5px solid #dc3545;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }

    .issue-card:hover {
      box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
    }

    .issue-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .issue-icon {
      font-size: 2rem;
    }

    .issue-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #dc3545;
    }

    .issue-details {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .issue-detail {
      color: #d4af37;
      opacity: 0.9;
      font-size: 0.95rem;
    }

    .issue-detail strong {
      opacity: 1;
      font-weight: 600;
    }

    .issue-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn-resolve-issue {
      background: rgba(40, 167, 69, 0.2);
      border: 2px solid #28a745;
      color: #28a745;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-resolve-issue:hover {
      background: rgba(40, 167, 69, 0.4);
      transform: scale(1.02);
    }

    @media (max-width: 768px) {
      .main-title {
        font-size: 1.8rem;
      }
      
      .grid-container {
        grid-template-columns: 1fr;
        padding: 0 1rem;
      }

      .back-button {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .date-banner-actions {
        flex-wrap: wrap;
        width: 100%;
      }

      .btn-save-pdf, .btn-print-pdf, .btn-delete-all {
        flex: 1;
        min-width: 100px;
      }

      .archive-card {
        flex-direction: column;
      }

      /* Minibar Counter Mobile Optimizations */
      .stock-counter-container {
        padding: 0;
      }

      .progress-indicator {
        font-size: 1rem;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
      }

      .counter-panel {
        padding: 1.5rem 1rem;
      }

      .stock-counter-grid {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
        margin-bottom: 1rem !important;
      }

      .dropdown-group {
        margin-bottom: 1rem;
      }

      .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
      }

      .form-select {
        padding: 0.6rem;
        font-size: 0.9rem;
      }

      .display-area {
        padding: 0.75rem;
        margin-bottom: 1.25rem;
      }

      .display-number {
        font-size: 2rem;
      }

      .display-hint {
        font-size: 0.8rem;
      }

      .num-button {
        font-size: 1.5rem;
        padding: 1rem;
      }

      .number-pad {
        gap: 0.75rem;
        margin-bottom: 1.25rem;
      }

      .quick-buttons {
        gap: 0.5rem;
        margin-bottom: 1.25rem;
      }

      .quick-btn {
        font-size: 1rem;
        padding: 0.6rem;
      }

      .save-item-btn {
        font-size: 1.1rem;
        padding: 1rem;
      }

      .room-floor-section {
        margin-bottom: 2rem;
      }

      .room-floor-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 1rem;
      }

      .room-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
      }

      .room-card {
        background: rgba(13, 27, 42, 0.7);
        border: 2px solid #d4af37;
        border-radius: 14px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .room-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(212, 175, 55, 0.2);
      }

      .room-number {
        font-size: 1.1rem;
        font-weight: 700;
        color: #d4af37;
      }

      .room-status {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .room-status.good {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.5);
      }

      .room-status.issues {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.5);
      }

      .room-status.setup {
        background: rgba(108, 117, 125, 0.2);
        color: #adb5bd;
        border: 1px solid rgba(173, 181, 189, 0.5);
      }

      .room-section {
        background: rgba(13, 27, 42, 0.7);
        border: 2px solid #d4af37;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .room-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 1rem;
      }

      .room-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding: 0.9rem 1.2rem;
        border: 1px solid rgba(212, 175, 55, 0.45);
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 10px 24px rgba(2, 6, 15, 0.25);
      }

      .room-item:last-child {
        border-bottom: none;
      }

      .setup-container {
        max-width: 896px;
        margin: 0 auto;
        padding: 1.5rem 1rem;
        background: radial-gradient(circle at top, rgba(18, 33, 62, 0.95), rgba(8, 16, 32, 0.95));
        border: 1px solid rgba(212, 175, 55, 0.45);
        border-radius: 24px;
        box-shadow: 0 28px 60px rgba(2, 6, 15, 0.6);
        color: #f4e4a8;
      }

      .setup-container,
      .setup-container * {
        color: #f4e4a8 !important;
      }

      .setup-title,
      .setup-category-title {
        color: #d4af37 !important;
      }

      .setup-container * {
        color: inherit;
      }

      @media (min-width: 768px) {
        .setup-container {
          padding: 1.5rem 2rem;
        }
      }

      .setup-back {
        margin-bottom: 1.5rem;
      }

      .setup-title {
        font-size: 2rem;
        font-weight: 700;
        color: #d4af37;
        text-align: center;
        margin-bottom: 2rem;
        text-shadow: 0 10px 30px rgba(212, 175, 55, 0.25);
      }

      @media (min-width: 768px) {
        .setup-title {
          font-size: 2.5rem;
        }
      }

      .setup-subtitle {
        font-size: 1.125rem;
        color: #f4e4a8;
        text-align: center;
        margin-bottom: 2rem;
        opacity: 0.9;
      }

      .setup-category {
        margin-bottom: 2rem;
        padding: 1.6rem;
        border-radius: 18px;
        border: 1px solid rgba(212, 175, 55, 0.35);
        background: rgba(9, 18, 38, 0.95);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
      }

      .setup-category-title {
        font-size: 1.65rem;
        color: #d4af37;
        margin-bottom: 1.25rem;
        letter-spacing: 0.4px;
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        padding-bottom: 0.6rem;
      }

      .checklist-items {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
      }

      @media (min-width: 1024px) {
        .checklist-items {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 1rem;
        }
      }

      .checklist-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1.15rem 1.3rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(212, 175, 55, 0.5);
        width: 100%;
        box-sizing: border-box;
        flex-wrap: nowrap;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        justify-content: space-between;
        box-shadow: 0 12px 26px rgba(2, 6, 15, 0.3);
        overflow: hidden;
      }

      .checklist-item:hover {
        transform: translateY(-3px);
        border-color: #f4d889;
        box-shadow: 0 18px 36px rgba(212, 175, 55, 0.2);
      }

      .checklist-checkbox {
        width: 1.35rem;
        height: 1.35rem;
        cursor: pointer;
        accent-color: #d4af37;
        margin-top: 2px;
      }

      .checklist-label {
        flex: 1;
        color: #f4e4a8;
        font-size: 1.2rem;
        cursor: pointer;
        line-height: 1.5;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .checklist-qty {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
        padding: 0.4rem 0.7rem;
        border-radius: 999px;
        background: rgba(11, 26, 51, 0.95);
        border: 1px solid rgba(212, 175, 55, 0.5);
        width: auto;
        justify-content: center;
      }

      .checklist-qty span {
        font-size: 0.95rem;
        color: #f4e4a8;
      }

      .checklist-qty input {
        width: 5.5rem;
        padding: 0.6rem;
        border-radius: 999px;
        color: #d4af37;
        border: 2px solid rgba(212, 175, 55, 0.7);
        background: rgba(10, 17, 40, 0.95);
        text-align: center;
        outline: none;
        font-weight: 600;
      }

      .checklist-qty input:focus {
        border-color: #d4af37;
      }

      .setup-add-btn {
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .setup-add-btn .btn-submit,
      .setup-save .btn-submit {
        box-shadow: 0 14px 24px rgba(212, 175, 55, 0.2);
      }

      .setup-form {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(10, 17, 40, 0.9), rgba(5, 10, 26, 0.95));
        border: 2px solid #d4af37;
      }

      .setup-form.hidden {
        display: none;
      }

      .setup-form-title {
        font-size: 1.5rem;
        color: #d4af37;
        margin-bottom: 1rem;
      }

      .setup-form label {
        color: #d4af37;
        font-weight: 500;
        display: block;
        margin-bottom: 0.5rem;
      }

      .setup-form input,
      .setup-form select {
        width: 100%;
        padding: 0.75rem;
        border-radius: 8px;
        color: #d4af37;
        border: 2px solid #b8941f;
        background: rgba(10, 17, 40, 0.6);
        outline: none;
      }

      .setup-form input:focus,
      .setup-form select:focus {
        border-color: #d4af37;
      }

      .setup-form-actions {
        display: flex;
        gap: 0.75rem;
      }

      .setup-save {
        text-align: center;
        margin-top: 2rem;
      }

      .room-item-name {
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 0.3rem;
      }

      .room-item-meta {
        font-size: 0.9rem;
        color: #d4af37;
        opacity: 0.8;
      }

      .room-item-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .room-action-btn {
        background: rgba(212, 175, 55, 0.15);
        border: 1px solid #d4af37;
        color: #d4af37;
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .room-action-btn.danger {
        border-color: #dc3545;
        color: #dc3545;
        background: rgba(220, 53, 69, 0.15);
      }

      .room-action-btn.warn {
        border-color: #ffc107;
        color: #ffc107;
        background: rgba(255, 193, 7, 0.15);
      }

      .maintenance-card {
        background: rgba(13, 27, 42, 0.7);
        border: 2px solid #d4af37;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .maintenance-title {
        font-weight: 700;
        color: #d4af37;
        margin-bottom: 0.4rem;
      }

      /* Reduce top/bottom padding on counter page */
      #stockCountPage {
        padding-top: 0.5rem !important;
      }

      #stockCountPage h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 768px) {
      .main-wrapper > div {
        padding: 1rem !important;
      }

      .main-title {
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        padding: 0 0.5rem;
      }

      .grid-container {
        grid-template-columns: 1fr;
        gap: 1rem;
        padding: 0 1rem;
      }

      .premium-card {
        padding: 1.5rem;
      }

      .card-emoji {
        font-size: 3rem;
      }

      .card-title {
        font-size: 1.2rem;
      }

      .expiration-page,
      .form-container,
      .date-header {
        padding: 1.25rem;
      }

      .expiration-page {
        max-width: none;
        width: 100%;
        padding: 0.75rem 0.75rem 1.5rem;
      }

      .stock-counter-container {
        max-width: none;
        width: 100%;
        padding: 0 0.25rem;
      }

      .counter-panel,
      .form-container,
      .date-header {
        width: 100%;
        box-sizing: border-box;
      }

      .counter-panel {
        padding: 1rem 0.75rem;
      }

      .date-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .date-display {
        font-size: 1.2rem;
      }

      .stats-container {
        width: 100%;
        justify-content: space-between;
        gap: 1rem;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .form-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .form-input,
      .form-select {
        font-size: 0.95rem;
        padding: 0.65rem;
      }

      .form-buttons {
        flex-direction: column;
        gap: 0.75rem;
      }

      .btn-submit,
      .btn-cancel {
        width: 100%;
      }

      .item-card {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }

      .item-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
        width: 100%;
      }

      .item-actions button {
        width: 100%;
      }

      .item-main,
      .notifications-list {
        width: 100%;
      }

      .back-button {
        width: 100%;
        text-align: center;
      }

      .notifications-list.expanded {
        max-height: 320px;
      }

      .date-banner {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.75rem;
        padding: 1rem;
        width: 100%;
        box-sizing: border-box;
      }

      .date-banner-left {
        display: block !important;
        width: 100%;
        position: relative;
        padding-left: 1.6rem;
      }

      .date-banner-left > * {
        display: block;
        width: 100%;
        margin-bottom: 0.35rem;
      }

      .date-banner-left > .expand-arrow {
        position: absolute;
        left: 0;
        top: 0.1rem;
        width: auto;
        margin-bottom: 0;
      }

      .date-banner-left > *:not(.expand-arrow) {
        padding-left: 0;
      }

      .date-banner-left > *:last-child {
        margin-bottom: 0;
      }

      .date-title {
        width: 100%;
      }

      .item-count-badge {
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
        width: fit-content;
      }

      .date-banner .btn-delete-all {
        width: 100% !important;
        align-self: stretch;
      }

      .date-banner-actions {
        width: 100% !important;
        justify-content: flex-start;
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div class="main-wrapper">
   <div style="padding: 2rem 2rem 3rem 2rem;"><button class="back-button hidden" id="backButton">â† Back</button>
    <h1 class="main-title" id="mainTitle">Housekeeping Inventory &amp; Stock</h1><!-- Main Menu -->
    <div id="mainMenu" class="grid-container">
    <div class="premium-card" data-page="minibar" onclick="goTo('minibar')"><span class="card-emoji">ğŸ¾</span>
      <div class="card-title">
       Minibar Operations
      </div>
      </div>
    <div class="premium-card" data-page="orders" onclick="goTo('orders')">
      <div class="notification-badge" id="notificationBadge">
       0
      </div><span class="card-emoji">ğŸ“¦</span>
      <div class="card-title">
       Order Management
      </div>
     </div>
    <div class="premium-card" data-page="housekeeping" onclick="goTo('housekeeping')"><span class="card-emoji">ğŸ§¹</span>
      <div class="card-title">
       Housekeeping Stock
      </div>
     </div>
    <div class="premium-card" data-page="archive" onclick="goTo('archive')"><span class="card-emoji">ğŸ“š</span>
      <div class="card-title">
       Archive
      </div>
     </div>
    <div class="premium-card" data-page="room-registry" onclick="goTo('room-registry')"><span class="card-emoji">ğŸ¨</span>
      <div class="card-title">
       Room Registry
      </div>
     </div>
    <div class="premium-card" data-page="stock-locations" onclick="goTo('stock-locations')"><span class="card-emoji">ğŸ“</span>
      <div class="card-title">
       Stock Locations
      </div>
     </div>
    </div>
    
    <!-- Minibar Operations Submenu -->
    <div id="minibarMenu" class="grid-container hidden">
    <div class="premium-card" data-subpage="expiration" onclick="goTo('expiration')"><span class="card-emoji">â°</span>
      <div class="card-title">
       Expiration Control
      </div>
     </div>
    <div class="premium-card" data-subpage="stockcount" onclick="goTo('stockcount')"><span class="card-emoji">ğŸ“¦</span>
      <div class="card-title">
       Minibar Counter
      </div>
     </div>
    </div><!-- Stock Counter Page -->
    <div id="stockCountPage" class="expiration-page hidden">
     <div class="stock-counter-container">
      <div class="progress-indicator" id="stockProgress">
       Progress: 0/0 items entered âœ“
      </div>
      <div class="counter-panel">
       <div class="stock-counter-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div class="dropdown-group" style="margin-bottom: 0;"><label class="form-label">Floor *</label> <select class="form-select" id="floorSelect"> <option value="">Select floor...</option> <option value="F1">F1 - Floor 1</option> <option value="F2">F2 - Floor 2</option> <option value="F3">F3 - Floor 3</option> <option value="Office">Office</option> </select>
        </div>
        <div class="dropdown-group" style="margin-bottom: 0;"><label class="form-label">Item *</label> <select class="form-select" id="stockItemSelect"> <option value="">Select an item...</option> <optgroup label="ğŸ¥¨ Snacks"> <option value="Fudge">Fudge</option> <option value="Cheese Nibbles">Cheese Nibbles</option> <option value="Chips">Chips</option> <option value="Almonds">Almonds</option> <option value="Chocolate Peanuts">Chocolate Peanuts</option> </optgroup> <optgroup label="ğŸ¥¤ Soft Drinks"> <option value="Sparkling Water">Sparkling Water</option> <option value="Coca-Cola">Coca-Cola</option> <option value="Coca-Cola Zero">Coca-Cola Zero</option> <option value="Tonic">Tonic</option> <option value="Apple Juice">Apple Juice</option> <option value="Ginger Ale">Ginger Ale</option> <option value="Lemonade">Lemonade</option> </optgroup> <optgroup label="ğŸº Alcohol"> <option value="Heineken">Heineken</option> <option value="Red Wine">Red Wine</option> <option value="White Wine">White Wine</option> <option value="Vodka">Vodka</option> <option value="Gin">Gin</option> <option value="Rum">Rum</option> <option value="Jack Daniels">Jack Daniels</option> <option value="Johnnie Walker">Johnnie Walker</option> </optgroup> </select>
        </div>
       </div>
       <div class="display-area" id="displayArea">
        <div class="display-number" id="displayNumber">
         0
        </div>
       </div><button class="save-item-btn" id="saveStockBtn">âœ… Save This Item</button>
       <div class="number-pad" style="margin-top: 1.5rem;"><button class="num-button" data-num="7">7</button> <button class="num-button" data-num="8">8</button> <button class="num-button" data-num="9">9</button> <button class="num-button" data-num="4">4</button> <button class="num-button" data-num="5">5</button> <button class="num-button" data-num="6">6</button> <button class="num-button" data-num="1">1</button> <button class="num-button" data-num="2">2</button> <button class="num-button" data-num="3">3</button> <button class="num-button wide" data-num="0">0</button> <button class="num-button" data-action="backspace">âŒ«</button>
       </div>
       <div class="quick-buttons"><button class="quick-btn" data-quick="5">5</button> <button class="quick-btn" data-quick="10">10</button> <button class="quick-btn" data-quick="15">15</button> <button class="quick-btn" data-quick="20">20</button>
       </div>
      </div><!-- Today's Stock Count Banner -->
      <div id="todayStockCountBanner" style="margin-top: 2rem;"></div>
     </div>
    </div><!-- Order Management / Notification Center Page -->
    <div id="ordersPage" class="expiration-page hidden">
     <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; text-align: center; margin-bottom: 2rem;">Notification Center</h2>
     <div class="order-summary" id="orderSummaryContainer">
      <div class="order-summary-header">
       <div class="order-summary-title">Order Summary</div>
       <div class="order-summary-actions">
        <button class="order-summary-btn" id="toggleOrderSummaryBtn">Collapse</button>
      <button class="order-summary-btn" id="clearOrderSummaryBtn">Clear Summary</button>
      <button class="order-summary-btn" id="rebuildOrderSummaryBtn">Rebuild Summary</button>
      <button class="order-summary-btn primary" id="printOrderSummaryBtn">Print PDF</button>
       </div>
      </div>
      <div class="order-summary-list" id="orderSummaryList"></div>
      <div class="order-summary-empty" id="orderSummaryEmpty"></div>
     </div>
     <div id="notificationFormContainer" class="form-container hidden">
      <form id="notificationForm">
       <div class="form-row">
        <div class="form-group"><label class="form-label" for="notificationType">Notification Type *</label> <select class="form-select" id="notificationType" required> <option value="">Select type...</option> <option value="low_stock">ğŸ“‰ Low Stock</option> <option value="damaged">âš ï¸ Damaged Item</option> <option value="broken">ğŸ”§ Broken Equipment</option> <option value="stolen">    Stolen/Missing</option> <option value="missing">â“ Item Missing</option> <option value="other">ğŸ“ Other Issue</option> </select>
        </div>
       </div>
       <div id="dynamicFormFields"></div>
       <div class="form-buttons"><button type="button" class="btn-cancel" id="cancelNotificationBtn">Cancel</button> <button type="submit" class="btn-submit" id="submitNotificationBtn">Add Notification</button>
       </div>
      </form>
     </div>
     <div id="notificationsContainer"></div>
    </div><!-- Housekeeping Stock Submenu -->
    <div id="housekeepingMenu" class="grid-container hidden">
    <div class="premium-card" data-subpage="housekeeping-equipment" onclick="goTo('housekeeping-equipment')"><span class="card-emoji">ğŸ§¹</span>
      <div class="card-title">
       Housekeeping Equipment
      </div>
     </div>
    <div class="premium-card" data-subpage="public-area-equipment" onclick="goTo('public-area-equipment')"><span class="card-emoji">&#128679;</span>
      <div class="card-title">
       Public Area Equipment
      </div>
     </div>
    </div><!-- Housekeeping Equipment Page -->
    <!-- Room Registry Pages -->
    <div id="roomRegistryPage" class="expiration-page hidden">
     <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
      <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; margin: 0;">ğŸ¨ Room Registry</h2>
      <button class="btn-submit" id="maintenanceQueueBtn" style="width: auto;">ğŸ›  Maintenance Queue (<span id="maintenanceCount">0</span>)</button>
     </div>
     <div id="roomRegistryContainer"></div>
     <div id="roomDetailContainer" class="hidden"></div>
    </div>
    <div id="roomMaintenancePage" class="expiration-page hidden">
     <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; text-align: center; margin-bottom: 2rem;">ğŸ›  Maintenance Queue</h2>
     <div id="maintenanceList"></div>
    </div>
    <!-- Stock Locations Pages -->
    <div id="stockLocationsPage" class="expiration-page hidden" style="max-width: 1152px; margin: 0 auto;">
     <h2 class="playfair" style="font-size: 2.5rem; color: #d4af37; text-align: center; margin-bottom: 2rem; text-shadow: 0 0 20px rgba(212, 175, 55, 0.4);">Stock Locations</h2>
     <p style="font-size: 1.125rem; color: #f4e4a8; text-align: center; margin-bottom: 2rem;">Manage 38 storage locations across the hotel</p>
     <div id="stockLocationsContainer"></div>
    </div>
    <div id="stockDetailPage" class="expiration-page hidden">
     <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
      <button class="btn-cancel" id="backToStockLocationsBtn">â† Back to Locations</button>
      <div>
       <h2 id="stockDetailTitle" style="font-size: 2rem; font-weight: 700; color: #d4af37; margin: 0;">Stock Location</h2>
       <div id="stockDetailMeta" style="color: #d4af37; opacity: 0.8; margin-top: 0.35rem;"></div>
      </div>
      <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
       <button class="btn-submit" id="stockCheckedBtn">âœ… Mark Checked</button>
       <button class="btn-submit" id="addStockItemBtn">â• Add Item</button>
      </div>
     </div>
     <div id="stockDetailContainer"></div>
    </div>
    <!-- Housekeeping Equipment Page -->
    <div id="housekeepingEquipmentPage" class="expiration-page hidden">
     <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; text-align: center; margin-bottom: 2rem;">ğŸ§¹ Equipment Inventory</h2><!-- Tab Navigation -->
     <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;"><button class="equipment-tab active" id="inventoryTab" data-tab="inventory"> ğŸ“¦ Inventory </button> <button class="equipment-tab" id="issuesTab" data-tab="issues"> âš ï¸ Active Issues </button>
     </div><!-- Inventory Tab Content -->
     <div id="inventoryTabContent"><button class="add-button" id="addEquipmentBtn">â• Add New Equipment</button>
      <div id="equipmentFormContainer" class="form-container hidden">
       <form id="equipmentForm">
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="equipmentItem">Equipment Item *</label> <select class="form-select" id="equipmentItem" required> <option value="">Select equipment...</option> <optgroup label="     Uniform &amp; PPE"> <option value="Aprons">Aprons</option> <option value="T-shirts">T-shirts</option> <option value="Gloves">Gloves</option> </optgroup> <optgroup label="ğŸ§¹ Cleaning Tools"> <option value="Toilet brush">Toilet brush</option> <option value="Plumo (feather duster)">Plumo (feather duster)</option> <option value="Cleaning caddy">Cleaning caddy</option> <option value="Mop stick">Mop stick</option> <option value="Mop head (Velcro)">Mop head (Velcro)</option> <option value="Brush">Brush</option> <option value="Microfiber cloths">Microfiber cloths</option> <option value="Sponges">Sponges</option> <option value="Squeegee">Squeegee</option> </optgroup> <optgroup label="ğŸšš Equipment &amp; Trolleys"> <option value="Housekeeping cart">Housekeeping cart</option> <option value="Laundry trolley">Laundry trolley</option> <option value="Laundry trolley with mobile holder">Laundry trolley with mobile holder</option> </optgroup> <optgroup label="ğŸ§º Laundry &amp; Waste"> <option value="Laundry net">Laundry net</option> <option value="Trash bag clips">Trash bag clips</option> </optgroup> <optgroup label="ğŸŒ€ Machines &amp; Accessories"> <option value="Vacuum cleaner">Vacuum cleaner</option> <option value="Vacuum cleaner head">Vacuum cleaner head</option> </optgroup> </select>
         </div>
        </div><!-- T-shirt Size Fields (hidden by default) -->
        <div id="tshirtSizeFields" class="hidden">
         <div class="form-row">
          <div class="form-group"><label class="form-label" for="sizeXS">XS Quantity</label> <input type="number" class="form-input" id="sizeXS" min="0" value="0">
          </div>
          <div class="form-group"><label class="form-label" for="sizeS">S Quantity</label> <input type="number" class="form-input" id="sizeS" min="0" value="0">
          </div>
          <div class="form-group"><label class="form-label" for="sizeM">M Quantity</label> <input type="number" class="form-input" id="sizeM" min="0" value="0">
          </div>
         </div>
         <div class="form-row">
          <div class="form-group"><label class="form-label" for="sizeL">L Quantity</label> <input type="number" class="form-input" id="sizeL" min="0" value="0">
          </div>
          <div class="form-group"><label class="form-label" for="sizeXL">XL Quantity</label> <input type="number" class="form-input" id="sizeXL" min="0" value="0">
          </div>
          <div class="form-group"><label class="form-label" for="sizeXXL">XXL Quantity</label> <input type="number" class="form-input" id="sizeXXL" min="0" value="0">
          </div>
         </div>
        </div><!-- Regular Quantity Field (for non-tshirt items) -->
        <div id="regularQuantityField">
         <div class="form-row">
          <div class="form-group"><label class="form-label" for="equipmentQuantity">Quantity *</label> <input type="number" class="form-input" id="equipmentQuantity" min="1" required>
          </div>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="equipmentPurchaseDate">Purchase Date *</label> <input type="date" class="form-input" id="equipmentPurchaseDate" required>
         </div>
         <div class="form-group"><label class="form-label" for="equipmentStatus">Initial Status *</label> <select class="form-select" id="equipmentStatus" required> <option value="working">ğŸŸ¢ Working</option> <option value="broken">ğŸ”´ Broken</option> <option value="maintenance">ğŸŸ¡ Maintenance</option> </select>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="equipmentLocation">Location (Optional)</label> <input type="text" class="form-input" id="equipmentLocation" placeholder="e.g., Storage Room A, Floor 2 Closet">
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="equipmentNotes">Notes (Optional)</label> <textarea class="form-input" id="equipmentNotes" placeholder="Additional notes..." rows="3" style="resize: vertical;"></textarea>
         </div>
        </div>
        <div class="form-buttons"><button type="button" class="btn-cancel" id="cancelEquipmentBtn">Cancel</button> <button type="submit" class="btn-submit" id="submitEquipmentBtn">Add Equipment</button>
        </div>
       </form>
      </div>
      <div id="equipmentInventoryContainer"></div>
     </div><!-- Active Issues Tab Content -->
     <div id="issuesTabContent" class="hidden">
      <div id="equipmentIssuesContainer"></div>
     </div>
    </div><!-- Public Area Equipment Page -->
    <div id="publicAreaEquipmentPage" class="expiration-page hidden">
     <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; text-align: center; margin-bottom: 2rem;">ğŸš§ Public Area Equipment</h2><!-- Tab Navigation -->
     <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem;"><button class="equipment-tab active" id="publicInventoryTab" data-tab="inventory"> ğŸ“¦ Inventory </button> <button class="equipment-tab" id="publicIssuesTab" data-tab="issues"> âš ï¸ Active Issues </button>
     </div><!-- Inventory Tab Content -->
     <div id="publicInventoryTabContent"><button class="add-button" id="addPublicEquipmentBtn">â• Add New Equipment</button>
      <div id="publicEquipmentFormContainer" class="form-container hidden">
       <form id="publicEquipmentForm">
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="publicEquipmentItem">Equipment Item *</label> <select class="form-select" id="publicEquipmentItem" required> <option value="">Select equipment...</option> <optgroup label="âš ï¸ Safety"> <option value="Wet floor signs">Wet floor signs</option> </optgroup> <optgroup label="ğŸš¬ Outside / Entrance"> <option value="Ashtrays (outside)">Ashtrays (outside)</option> <option value="Waste bins (outside) - Paper">Waste bins (outside) - Paper</option> <option value="Waste bins (outside) - General waste">Waste bins (outside) - General waste</option> <option value="Waste bins (outside) - Glass">Waste bins (outside) - Glass</option> </optgroup> <optgroup label="ğŸš» Public Toilets"> <option value="Toilet seats">Toilet seats</option> <option value="Toilet brushes">Toilet brushes</option> <option value="Decorative mirrors (toilets)">Decorative mirrors (toilets)</option> <option value="Waste bins">Waste bins</option> <option value="Big bin">Big bin</option> <option value="Paper towel holder">Paper towel holder</option> <option value="Mop buckets with wringer">Mop buckets with wringer</option> </optgroup> <optgroup label="â™¿ Accessible Toilet"> <option value="Accessible (disabled) toilet">Accessible (disabled) toilet</option> <option value="Baby changing table">Baby changing table</option> <option value="Accessible (disabled) shower chair">Accessible (disabled) shower chair</option> </optgroup> <optgroup label="ğŸ§¹ Cleaning Equipment"> <option value="Vacuum cleaner (Lobby)">Vacuum cleaner (Lobby)</option> <option value="Handheld vacuum (Office)">Handheld vacuum (Office)</option> <option value="Floor scrubber / single-disc machine">Floor scrubber / single-disc machine</option> <option value="Mop bucket with wringer">Mop bucket with wringer</option> <option value="Broom &amp; dustpan">Broom &amp; dustpan</option> <option value="Dusters">Dusters</option> </optgroup> </select>
         </div>
        </div><!-- Regular Quantity Field -->
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="publicEquipmentQuantity">Quantity *</label> <input type="number" class="form-input" id="publicEquipmentQuantity" min="1" required>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="publicEquipmentPurchaseDate">Purchase Date *</label> <input type="date" class="form-input" id="publicEquipmentPurchaseDate" required>
         </div>
         <div class="form-group"><label class="form-label" for="publicEquipmentStatus">Initial Status *</label> <select class="form-select" id="publicEquipmentStatus" required> <option value="working">ğŸŸ¢ Working</option> <option value="broken">ğŸ”´ Broken</option> <option value="maintenance">ğŸŸ¡ Maintenance</option> </select>
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="publicEquipmentLocation">Location (Optional)</label> <input type="text" class="form-input" id="publicEquipmentLocation" placeholder="e.g., Lobby, Main Entrance, Floor 2 Toilets">
         </div>
        </div>
        <div class="form-row">
         <div class="form-group"><label class="form-label" for="publicEquipmentNotes">Notes (Optional)</label> <textarea class="form-input" id="publicEquipmentNotes" placeholder="Additional notes..." rows="3" style="resize: vertical;"></textarea>
         </div>
        </div>
        <div class="form-buttons"><button type="button" class="btn-cancel" id="cancelPublicEquipmentBtn">Cancel</button> <button type="submit" class="btn-submit" id="submitPublicEquipmentBtn">Add Equipment</button>
        </div>
       </form>
      </div>
      <div id="publicEquipmentInventoryContainer"></div>
     </div><!-- Active Issues Tab Content -->
     <div id="publicIssuesTabContent" class="hidden">
      <div id="publicEquipmentIssuesContainer"></div>
     </div>
    </div><!-- Archive Page -->
    <!-- Room Registry Pages (moved near end of layout) -->
    <div id="archivePage" class="expiration-page hidden">
     <h2 style="font-size: 2rem; font-weight: 700; color: #d4af37; text-align: center; margin-bottom: 3rem;">Archive Center</h2><!-- Section 1: Archived Stock Counts -->
     <div class="archive-section">
      <h3 class="archive-section-title">ğŸ“Š Archived Stock Counts</h3>
      <div id="stockCountArchiveContainer"></div>
     </div>
     <div class="archive-divider"></div><!-- Section 2: Housekeeping Stock Archive -->
     <div class="archive-section">
      <h3 class="archive-section-title">ğŸ§¹ Housekeeping Stock Archive</h3>
      <div id="equipmentArchiveContainer"></div>
     </div>
     <div class="archive-divider"></div><!-- Section 3: Expired Items Archive -->
     <div class="archive-section">
      <h3 class="archive-section-title">â° Expired Items Archive</h3>
      <div id="expiredArchiveContainer"></div>
     </div>
    </div><!-- Expiration Control Page -->
    <div id="expirationPage" class="expiration-page hidden">
     <div class="date-header">
      <div class="date-display" id="currentDate">
       Loading...
      </div>
      <div class="stats-container">
       <div class="stat-item">
        <div class="stat-label">
         Expired Items Today
        </div>
        <div class="stat-value" id="itemCount">
         0
        </div>
       </div>
       <div class="stat-item">
        <div class="stat-label">
         Total Quantity
        </div>
        <div class="stat-value" id="totalQuantity">
         0
        </div>
       </div>
      </div>
     </div><button class="add-button" id="addItemBtn">â• Add Expired Item</button>
     <div id="formContainer" class="form-container hidden">
      <form id="expirationForm">
       <div class="form-row">
        <div class="form-group"><label class="form-label" for="itemName">Item Name *</label> <select class="form-select" id="itemName" required> <option value="">Select an item...</option> <optgroup label="ğŸ¥¨ Snacks"> <option value="Fudge">Fudge</option> <option value="Cheese Nibbles">Cheese Nibbles</option> <option value="Chips">Chips</option> <option value="Almonds">Almonds</option> <option value="Chocolate Peanuts">Chocolate Peanuts</option> </optgroup> <optgroup label="ğŸ¥¤ Soft Drinks"> <option value="Sparkling Water">Sparkling Water</option> <option value="Coca-Cola">Coca-Cola</option> <option value="Coca-Cola Zero">Coca-Cola Zero</option> <option value="Tonic">Tonic</option> <option value="Apple Juice">Apple Juice</option> <option value="Ginger Ale">Ginger Ale</option> <option value="Lemonade">Lemonade</option> </optgroup> <optgroup label="   Alcohol"> <option value="Heineken">Heineken</option> <option value="Red Wine">Red Wine</option> <option value="White Wine">White Wine</option> <option value="Vodka">Vodka</option> <option value="Gin">Gin</option> <option value="Rum">Rum</option> <option value="Jack Daniels">Jack Daniels</option> <option value="Johnnie Walker">Johnnie Walker</option> </optgroup> </select>
        </div>
        <div class="form-group"><label class="form-label" for="expirationDate">Expiration Date *</label> <input type="date" class="form-input" id="expirationDate" required>
        </div>
        <div class="form-group"><label class="form-label" for="location">Location *</label> <input type="tel" class="form-input" id="location" placeholder="e.g., Room 305" inputmode="numeric" pattern="[0-9]*" required>
        </div>
        <div class="form-group"><label class="form-label" for="quantity">Quantity</label> <input type="tel" class="form-input" id="quantity" placeholder="Optional" inputmode="numeric" pattern="[0-9]*">
        </div>
       </div>
       <div class="form-buttons"><button type="button" class="btn-cancel" id="cancelBtn">Cancel</button> <button type="submit" class="btn-submit" id="submitBtn">Add Item</button>
       </div>
      </form>
     </div>
     <div id="itemsContainer"></div>
    </div>
   </div>
  <footer class="footer-text" id="footerText">
    <span id="footerCopy">Â© M.A.2026</span>
    <span id="footerVersion" class="footer-version">vâ€”</span>
  </footer>
  <div id="buildBadge" class="build-badge" data-build="2026-02-04">Build vâ€”</div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "Housekeeping Inventory & Stock",
      footer_text: "Â© M.A.2026",
      background_color: "#0b1a33",
      accent_color: "#d4af37",
      font_family: "Segoe UI"
    };

    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwsojKnOgsgaKguFQFG7tA9nPijTmCyCWFqU0lu7bJCYfkunqduV4_meJiZOricnjr6/exec';
    const APP_PIN = '1012';
    function getLocalDateString(date = new Date()) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    const mainMenu = document.getElementById('mainMenu');
    const pinOverlay = document.getElementById('pinOverlay');
    const pinInput = document.getElementById('pinInput');
    const pinSubmit = document.getElementById('pinSubmit');
    const pinError = document.getElementById('pinError');
    const minibarMenu = document.getElementById('minibarMenu');
    const housekeepingMenu = document.getElementById('housekeepingMenu');
    const archivePage = document.getElementById('archivePage');
    const expirationPage = document.getElementById('expirationPage');
    const ordersPage = document.getElementById('ordersPage');
    const stockCountPage = document.getElementById('stockCountPage');
    const housekeepingEquipmentPage = document.getElementById('housekeepingEquipmentPage');
    const publicAreaEquipmentPage = document.getElementById('publicAreaEquipmentPage');
    const roomRegistryPage = document.getElementById('roomRegistryPage');
    const roomMaintenancePage = document.getElementById('roomMaintenancePage');
    const stockLocationsPage = document.getElementById('stockLocationsPage');
    const stockDetailPage = document.getElementById('stockDetailPage');
    const backButton = document.getElementById('backButton');
    let currentPage = 'main';
    var isUnlocked = true;
    let roomRegistryContainer;
    let roomDetailContainer;
    let maintenanceQueueBtn;
    let maintenanceList;
    let maintenanceCount;
    let allItems = [];
    let allNotifications = [];
    let allStockCounts = [];
    let allEquipment = [];
    let allPublicEquipment = [];
    let roomItems = [];
    let stockLocationItems = [];
    let archivedItems = [];
    let archivedNotifications = [];
    let archivedStockCounts = [];
    let currentStockLocation = null;
    let currentStockValue = 0;
    let currentEquipmentTab = 'inventory';
    let currentPublicEquipmentTab = 'inventory';

    // Category mapping for icons
    const categoryIcons = {
      'Fudge': 'ğŸ¥¨',
      'Cheese Nibbles': 'ğŸ¥¨',
      'Chips': 'ğŸ¥¨',
      'Almonds': 'ğŸ¥¨',
      'Chocolate Peanuts': 'ğŸ¥¨',
      'Sparkling Water': 'ğŸ¥¤',
      'Coca-Cola': 'ğŸ¥¤',
      'Coca-Cola Zero': 'ğŸ¥¤',
      'Tonic': 'ğŸ¥¤',
      'Apple Juice': 'ğŸ¥¤',
      'Ginger Ale': 'ğŸ¥¤',
      'Lemonade': 'ğŸ¥¤',
      'Heineken': 'ğŸº',
      'Red Wine': 'ğŸº',
      'White Wine': 'ğŸº',
      'Vodka': 'ğŸº',
      'Gin': 'ğŸº',
      'Rum': 'ğŸº',
      'Jack Daniels': 'ğŸº',
      'Johnnie Walker': 'ğŸº'
    };

    // Initialize Data SDK
    const dataHandler = {
      onDataChanged(data) {
        const normalizeArchived = (value) => {
          if (value === true || value === false) return value;
          if (value === null || value === undefined || value === '') return false;
          const normalized = String(value).toLowerCase().trim();
          return normalized === 'true' || normalized === 'yes' || normalized === '1';
        };

        const normalizeDate = (value) => {
          if (!value) return '';
          if (value instanceof Date) return getLocalDateString(value);
          const raw = String(value).trim();
          if (!raw) return '';
          if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
          if (/^\d{2}-\d{2}-\d{4}$/.test(raw)) {
            const [day, month, year] = raw.split('-');
            return `${year}-${month}-${day}`;
          }
          const parsed = new Date(raw);
          if (!Number.isNaN(parsed.getTime())) {
            return getLocalDateString(parsed);
          }
          return raw;
        };

        const normalizeType = (value) => {
          if (!value) return '';
          return String(value).toLowerCase().replace(/\s+/g, '_').replace(/-+/g, '_');
        };

        const normalizedData = data.map(item => ({
          ...item,
          is_archived: normalizeArchived(item.is_archived),
          date_added: normalizeDate(item.date_added),
          location_name: item.location_name || item.location || item.stock_location || item.locationName || '',
          stock_type: normalizeType(item.stock_type),
          equipment_type: normalizeType(item.equipment_type),
          room_type: normalizeType(item.room_type)
        }));

        // Separate different types of data
        allItems = normalizedData.filter(item => !item.type && !item.stock_type && !item.equipment_type && !item.room_type && !item.is_archived);
        allNotifications = normalizedData.filter(item => item.type && !item.is_archived);
        allStockCounts = normalizedData.filter(item => item.stock_type === 'minibar_count' && !item.is_archived);
        allEquipment = normalizedData.filter(item => item.equipment_type === 'housekeeping' && !item.is_archived);
        allPublicEquipment = normalizedData.filter(item => item.equipment_type === 'public_area' && !item.is_archived);
        roomItems = normalizedData.filter(item => item.room_type === 'room_item' && !item.is_archived);
        stockLocationItems = normalizedData.filter(item => item.stock_type === 'stock_location' && !item.is_archived);
        archivedItems = normalizedData.filter(item => !item.type && !item.stock_type && !item.equipment_type && item.is_archived);
        archivedNotifications = normalizedData.filter(item => item.type && item.is_archived);
        archivedStockCounts = normalizedData.filter(item => item.stock_type === 'minibar_count' && item.is_archived);
        
        updateExpirationDisplay();
        updateNotificationsDisplay();
        updateNotificationBadge();
        updateArchiveDisplay();
        updateStockProgress();
        updateEquipmentDisplay();
        updatePublicEquipmentDisplay();
        
      }
    };

    function createLocalDataSdk(handler) {
      const storageKey = 'housekeeping-data';
      let data = [];

      function load() {
        try {
          const raw = localStorage.getItem(storageKey);
          const parsed = raw ? JSON.parse(raw) : [];
          data = Array.isArray(parsed) ? parsed : [];
        } catch (err) {
          console.error('Failed to load local data:', err);
          data = [];
        }
      }

      function persist() {
        try {
          localStorage.setItem(storageKey, JSON.stringify(data));
        } catch (err) {
          console.error('Failed to save local data:', err);
        }
      }

      function emit() {
        handler.onDataChanged([...data]);
      }

      return {
        async init() {
          load();
          emit();
          return { isOk: true };
        },
        async create(item) {
          data.push(item);
          persist();
          emit();
          return { isOk: true };
        },
        async update(item) {
          const idx = data.findIndex(existing => existing.id === item.id);
          if (idx >= 0) {
            data[idx] = item;
          } else {
            data.push(item);
          }
          persist();
          emit();
          return { isOk: true };
        },
        async delete(item) {
          data = data.filter(existing => existing.id !== item.id);
          persist();
          emit();
          return { isOk: true };
        }
      };
    }

    function createGoogleDataSdk(url, handler) {
      let cachedData = [];
      let refreshTimer = null;

      function scheduleRefresh(delay = 3000) {
        if (refreshTimer) clearTimeout(refreshTimer);
        refreshTimer = setTimeout(() => {
          refreshTimer = null;
          api.init();
        }, delay);
      }
      function compactPayload(payload) {
        if (!payload || typeof payload !== 'object') return payload;
        const compacted = {};
        Object.keys(payload).forEach(key => {
          const value = payload[key];
          if (value === null || value === undefined || value === '') return;
          compacted[key] = value;
        });
        return compacted;
      }

      function selectPayload(payload) {
        if (!payload || typeof payload !== 'object') return payload;
        if (payload.type) {
          return {
            id: payload.id,
            type: payload.type,
            item_name: payload.item_name,
            source: payload.source,
            location: payload.location,
            description: payload.description,
            added_timestamp: payload.added_timestamp,
            date_added: payload.date_added,
            is_archived: payload.is_archived,
            stock_f1: payload.stock_f1,
            stock_f2: payload.stock_f2,
            stock_f3: payload.stock_f3,
            stock_office: payload.stock_office,
            total_stock: payload.total_stock,
            order_quantity: payload.order_quantity
          };
        }

        if (payload.stock_type) {
          return {
            id: payload.id,
            stock_type: payload.stock_type,
            item_name: payload.item_name,
            location_name: payload.location_name,
            location: payload.location || payload.location_name,
            floor: payload.floor,
            quantity: payload.quantity,
            unit: payload.unit,
            notes: payload.notes,
            last_checked: payload.last_checked,
            added_timestamp: payload.added_timestamp,
            date_added: payload.date_added,
            is_archived: payload.is_archived
          };
        }

        if (payload.equipment_type) {
          return {
            id: payload.id,
            equipment_type: payload.equipment_type,
            item_name: payload.item_name,
            base_item: payload.base_item,
            size: payload.size,
            category: payload.category,
            quantity: payload.quantity,
            purchase_date: payload.purchase_date,
            status: payload.status,
            location: payload.location,
            notes: payload.notes,
            added_timestamp: payload.added_timestamp,
            issue_description: payload.issue_description,
            issue_reported_date: payload.issue_reported_date,
            is_archived: payload.is_archived
          };
        }

        return {
          id: payload.id,
          item_name: payload.item_name,
          expiration_date: payload.expiration_date,
          location: payload.location,
          quantity: payload.quantity,
          notes: payload.notes,
          added_timestamp: payload.added_timestamp,
          date_added: payload.date_added,
          is_archived: payload.is_archived
        };
      }

      function jsonpRequest(action, payload) {
        return new Promise((resolve, reject) => {
          const callbackName = `__gsCallback_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          const compacted = compactPayload(selectPayload(payload));
          const payloadParam = compacted ? `&payload=${encodeURIComponent(JSON.stringify(compacted))}` : '';
          const script = document.createElement('script');
          const timeoutId = setTimeout(() => {
            delete window[callbackName];
            script.remove();
            resolve({ isOk: false, error: 'JSONP request timed out' });
          }, 8000);

          window[callbackName] = (data) => {
            clearTimeout(timeoutId);
            delete window[callbackName];
            script.remove();
            resolve({ isOk: true, data });
          };

          script.onerror = () => {
            clearTimeout(timeoutId);
            delete window[callbackName];
            script.remove();
            resolve({ isOk: false, error: 'JSONP request failed' });
          };

          script.src = `${url}?action=${action}${payloadParam}&callback=${callbackName}&ts=${Date.now()}`;
          document.body.appendChild(script);
        });
      }

      const api = {
        async init() {
          const result = await jsonpRequest('read');
          if (!result.isOk) return result;
          cachedData = Array.isArray(result.data) ? result.data : [];
          handler.onDataChanged(cachedData);
          return { isOk: true };
        },
        async create(item) {
          cachedData = [...cachedData, item];
          handler.onDataChanged(cachedData);
          jsonpRequest('create', item).then(result => {
            if (!result.isOk) {
              showToast('Save failed. Sync will retry.', 'error');
              scheduleRefresh(12000);
              return;
            }
            scheduleRefresh(6000);
          });
          return { isOk: true, optimistic: true };
        },
        async update(item) {
          const result = await jsonpRequest('update', item);
          if (result.isOk) {
            const next = cachedData.map(existing =>
              String(existing.id) === String(item.id) ? { ...existing, ...item } : existing
            );
            cachedData = next;
            handler.onDataChanged(cachedData);
            scheduleRefresh(6000);
          }
          return result;
        },
        async delete(item) {
          const result = await jsonpRequest('delete', { id: item.id });
          if (result.isOk) {
            cachedData = cachedData.filter(existing => String(existing.id) !== String(item.id));
            handler.onDataChanged(cachedData);
            scheduleRefresh(6000);
          }
          return result;
        }
      };

      return api;
    }

    async function initializeDataSDK() {
      if (!window.dataSdk) {
        if (GOOGLE_APPS_SCRIPT_URL) {
          window.dataSdk = createGoogleDataSdk(GOOGLE_APPS_SCRIPT_URL, dataHandler);
        } else {
          window.dataSdk = createLocalDataSdk(dataHandler);
        }
      }
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error("Failed to initialize Data SDK:", result.error);
      }
    }

    function showPinLock() {
      if (!pinOverlay) return;
      pinOverlay.classList.remove('hidden');
      if (pinInput) {
        pinInput.value = '';
        pinInput.focus();
      }
    }

    function hidePinLock() {
      if (!pinOverlay) return;
      pinOverlay.classList.add('hidden');
    }

    function showDebugBanner(message) {
      let banner = document.getElementById('debugBanner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'debugBanner';
        banner.style.position = 'fixed';
        banner.style.bottom = '16px';
        banner.style.left = '16px';
        banner.style.right = '16px';
        banner.style.zIndex = '9999';
        banner.style.background = 'rgba(220, 53, 69, 0.95)';
        banner.style.color = '#fff';
        banner.style.padding = '12px 16px';
        banner.style.borderRadius = '10px';
        banner.style.fontSize = '14px';
        banner.style.fontWeight = '600';
        banner.style.boxShadow = '0 6px 20px rgba(0,0,0,0.35)';
        banner.style.wordBreak = 'break-word';
        document.body.appendChild(banner);
      }
      banner.textContent = `Debug: ${message}`;
    }

    window.addEventListener('error', (event) => {
      const message = event?.message || 'Unknown error';
      showDebugBanner(message);
    });

    window.addEventListener('unhandledrejection', (event) => {
      const reason = event?.reason?.message || String(event?.reason || 'Unhandled rejection');
      showDebugBanner(reason);
    });

    function tryUnlock() {
      if (!pinInput) return;
      const value = pinInput.value.trim();
      if (value === APP_PIN) {
        isUnlocked = true;
        try {
          localStorage.setItem('app_unlocked', 'true');
        } catch (err) {
          // Ignore storage errors and allow navigation
        }
        if (pinError) pinError.textContent = '';
        hidePinLock();
      } else {
        if (pinError) pinError.textContent = 'Incorrect PIN. Try again.';
        pinInput.value = '';
        pinInput.focus();
      }
    }

    function goTo(page) {
      if (!isUnlocked) {
        showPinLock();
        return;
      }
      navigateTo(page);
    }

    // Navigation handler
    document.querySelectorAll('.premium-card[data-page]').forEach(card => {
      card.addEventListener('click', function() {
        if (!isUnlocked) {
          showPinLock();
          return;
        }
        const page = this.getAttribute('data-page');
        navigateTo(page);
      });
    });

    // Add click handler for subpages
    document.querySelectorAll('.premium-card[data-subpage]').forEach(card => {
      card.addEventListener('click', function() {
        if (!isUnlocked) {
          showPinLock();
          return;
        }
        const subpage = this.getAttribute('data-subpage');
        navigateTo(subpage);
      });
    });

    if (pinSubmit) {
      pinSubmit.addEventListener('click', tryUnlock);
    }

    if (pinInput) {
      pinInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          tryUnlock();
        }
      });
    }

    if (!isUnlocked) {
      showPinLock();
    }

    if (backButton) {
      backButton.addEventListener('click', function() {
      if (currentPage === 'expiration' || currentPage === 'stockcount') {
        navigateTo('minibar');
      } else if (currentPage === 'orders') {
        navigateTo('main');
      } else if (currentPage === 'housekeeping-equipment' || currentPage === 'public-area-equipment') {
        navigateTo('housekeeping');
      } else if (currentPage === 'room-registry') {
        navigateTo('main');
      } else if (currentPage === 'room-maintenance') {
        navigateTo('room-registry');
      } else if (currentPage === 'stock-locations') {
        navigateTo('main');
      } else if (currentPage === 'stock-detail') {
        navigateTo('stock-locations');
      } else {
        navigateTo('main');
      }
      });
    }

    function navigateTo(page) {
      const mainTitle = document.getElementById('mainTitle');
      
      // Hide all menus and pages
      mainMenu.classList.add('hidden');
      minibarMenu.classList.add('hidden');
      housekeepingMenu.classList.add('hidden');
      archivePage.classList.add('hidden');
      expirationPage.classList.add('hidden');
      ordersPage.classList.add('hidden');
      stockCountPage.classList.add('hidden');
      housekeepingEquipmentPage.classList.add('hidden');
      publicAreaEquipmentPage.classList.add('hidden');
      roomRegistryPage.classList.add('hidden');
      roomMaintenancePage.classList.add('hidden');
      stockLocationsPage.classList.add('hidden');
      stockDetailPage.classList.add('hidden');

      // Show appropriate menu/page
      if (page === 'main') {
        mainMenu.classList.remove('hidden');
        backButton.classList.add('hidden');
        mainTitle.style.display = 'block';
        currentPage = 'main';
      } else if (page === 'minibar') {
        minibarMenu.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back';
        mainTitle.style.display = 'none';
        currentPage = 'minibar';
      } else if (page === 'orders') {
        ordersPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Dashboard';
        mainTitle.style.display = 'none';
        currentPage = 'orders';
        updateNotificationsDisplay();
      } else if (page === 'housekeeping') {
        housekeepingMenu.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back';
        mainTitle.style.display = 'none';
        currentPage = 'housekeeping';
      } else if (page === 'housekeeping-equipment') {
        housekeepingEquipmentPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Housekeeping Stock';
        mainTitle.style.display = 'none';
        currentPage = 'housekeeping-equipment';
        updateEquipmentDisplay();
      } else if (page === 'public-area-equipment') {
        publicAreaEquipmentPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Housekeeping Stock';
        mainTitle.style.display = 'none';
        currentPage = 'public-area-equipment';
        updatePublicEquipmentDisplay();
      } else if (page === 'room-registry') {
        roomRegistryPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Dashboard';
        mainTitle.style.display = 'none';
        currentPage = 'room-registry';
        renderRoomRegistry();
      } else if (page === 'room-maintenance') {
        roomMaintenancePage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Room Registry';
        mainTitle.style.display = 'none';
        currentPage = 'room-maintenance';
        renderMaintenanceQueue();
      } else if (page === 'stock-locations') {
        stockLocationsPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Dashboard';
        mainTitle.style.display = 'none';
        currentPage = 'stock-locations';
        renderStockLocations();
      } else if (page === 'stock-detail') {
        stockDetailPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Stock Locations';
        mainTitle.style.display = 'none';
        currentPage = 'stock-detail';
        renderStockDetail();
      } else if (page === 'archive') {
        archivePage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Main';
        mainTitle.style.display = 'none';
        currentPage = 'archive';
        updateArchiveDisplay();
      } else if (page === 'expiration') {
        expirationPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Minibar Operations';
        mainTitle.style.display = 'none';
        currentPage = 'expiration';
        updateCurrentDate();
        updateExpirationDisplay();
      } else if (page === 'stockcount') {
        stockCountPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        backButton.textContent = 'â† Back to Minibar Operations';
        mainTitle.style.display = 'none';
        currentPage = 'stockcount';
        updateStockProgress();
      }
    }

    // ============== HOUSEKEEPING EQUIPMENT FUNCTIONALITY ==============

    const addEquipmentBtn = document.getElementById('addEquipmentBtn');
    const equipmentFormContainer = document.getElementById('equipmentFormContainer');
    const equipmentForm = document.getElementById('equipmentForm');
    const cancelEquipmentBtn = document.getElementById('cancelEquipmentBtn');
    const submitEquipmentBtn = document.getElementById('submitEquipmentBtn');
    const equipmentItemSelect = document.getElementById('equipmentItem');
    const tshirtSizeFields = document.getElementById('tshirtSizeFields');
    const regularQuantityField = document.getElementById('regularQuantityField');
    const inventoryTab = document.getElementById('inventoryTab');
    const issuesTab = document.getElementById('issuesTab');
    const inventoryTabContent = document.getElementById('inventoryTabContent');
    const issuesTabContent = document.getElementById('issuesTabContent');

    const equipmentCategoryMap = {
      'Aprons': 'ğŸ‘• Uniform & PPE',
      'T-shirts': 'ğŸ‘• Uniform & PPE',
      'Gloves': 'ğŸ‘• Uniform & PPE',
      'Toilet brush': 'ğŸ§¹ Cleaning Tools',
      'Plumo (feather duster)': 'ğŸ§¹ Cleaning Tools',
      'Cleaning caddy': 'ğŸ§¹ Cleaning Tools',
      'Mop stick': 'ğŸ§¹ Cleaning Tools',
      'Mop head (Velcro)': 'ğŸ§¹ Cleaning Tools',
      'Brush': 'ğŸ§¹ Cleaning Tools',
      'Microfiber cloths': 'ğŸ§¹ Cleaning Tools',
      'Sponges': 'ğŸ§¹ Cleaning Tools',
      'Squeegee': 'ğŸ§¹ Cleaning Tools',
      'Housekeeping cart': 'ğŸšš Equipment & Trolleys',
      'Laundry trolley': 'ğŸšš Equipment & Trolleys',
      'Laundry trolley with mobile holder': 'ğŸšš Equipment & Trolleys',
      'Laundry net': 'ğŸ§º Laundry & Waste',
      'Trash bag clips': 'ğŸ§º Laundry & Waste',
      'Vacuum cleaner': 'ğŸŒ€ Machines & Accessories',
      'Vacuum cleaner head': 'ğŸŒ€ Machines & Accessories'
    };

    const equipmentCategoryIcons = {
      'ğŸ‘• Uniform & PPE': 'ğŸ‘•',
      'ğŸ§¹ Cleaning Tools': 'ğŸ§¹',
      'ğŸšš Equipment & Trolleys': 'ğŸšš',
      'ğŸ§º Laundry & Waste': 'ğŸ§º',
      'ğŸŒ€ Machines & Accessories': 'ğŸŒ€'
    };

    // ============== PUBLIC AREA EQUIPMENT FUNCTIONALITY ==============

    const addPublicEquipmentBtn = document.getElementById('addPublicEquipmentBtn');
    const publicEquipmentFormContainer = document.getElementById('publicEquipmentFormContainer');
    const publicEquipmentForm = document.getElementById('publicEquipmentForm');
    const cancelPublicEquipmentBtn = document.getElementById('cancelPublicEquipmentBtn');
    const submitPublicEquipmentBtn = document.getElementById('submitPublicEquipmentBtn');
    const publicEquipmentItemSelect = document.getElementById('publicEquipmentItem');
    const publicInventoryTab = document.getElementById('publicInventoryTab');
    const publicIssuesTab = document.getElementById('publicIssuesTab');
    const publicInventoryTabContent = document.getElementById('publicInventoryTabContent');
    const publicIssuesTabContent = document.getElementById('publicIssuesTabContent');

    const publicEquipmentCategoryMap = {
      'Wet floor signs': 'âš ï¸ Safety',
      'Ashtrays (outside)': 'ğŸš¬ Outside / Entrance',
      'Waste bins (outside) - Paper': 'ğŸš¬ Outside / Entrance',
      'Waste bins (outside) - General waste': 'ğŸš¬ Outside / Entrance',
      'Waste bins (outside) - Glass': 'ğŸš¬ Outside / Entrance',
      'Toilet seats': 'ğŸš» Public Toilets',
      'Toilet brushes': 'ğŸš» Public Toilets',
      'Decorative mirrors (toilets)': 'ğŸš» Public Toilets',
      'Waste bins': 'ğŸš» Public Toilets',
      'Big bin': 'ğŸš» Public Toilets',
      'Paper towel holder': 'ğŸš» Public Toilets',
      'Mop buckets with wringer': 'ğŸš» Public Toilets',
      'Accessible (disabled) toilet': 'â™¿ Accessible Toilet',
      'Baby changing table': 'â™¿ Accessible Toilet',
      'Accessible (disabled) shower chair': 'â™¿ Accessible Toilet',
      'Vacuum cleaner (Lobby)': 'ğŸ§¹ Cleaning Equipment',
      'Handheld vacuum (Office)': 'ğŸ§¹ Cleaning Equipment',
      'Floor scrubber / single-disc machine': 'ğŸ§¹ Cleaning Equipment',
      'Mop bucket with wringer': 'ğŸ§¹ Cleaning Equipment',
      'Broom & dustpan': 'ğŸ§¹ Cleaning Equipment',
      'Dusters': 'ğŸ§¹ Cleaning Equipment'
    };

    const publicEquipmentCategoryIcons = {
      'âš ï¸ Safety': 'âš ï¸',
      'ğŸš¬ Outside / Entrance': 'ğŸš¬',
      'ğŸš» Public Toilets': 'ğŸš»',
      'â™¿ Accessible Toilet': 'â™¿',
      'ğŸ§¹ Cleaning Equipment': 'ğŸ§¹'
    };

    // Tab switching for Housekeeping Equipment
    inventoryTab.addEventListener('click', function() {
      currentEquipmentTab = 'inventory';
      inventoryTab.classList.add('active');
      issuesTab.classList.remove('active');
      inventoryTabContent.classList.remove('hidden');
      issuesTabContent.classList.add('hidden');
    });

    issuesTab.addEventListener('click', function() {
      currentEquipmentTab = 'issues';
      issuesTab.classList.add('active');
      inventoryTab.classList.remove('active');
      issuesTabContent.classList.remove('hidden');
      inventoryTabContent.classList.add('hidden');
      updateEquipmentIssuesDisplay();
    });

    // Tab switching for Public Area Equipment
    publicInventoryTab.addEventListener('click', function() {
      currentPublicEquipmentTab = 'inventory';
      publicInventoryTab.classList.add('active');
      publicIssuesTab.classList.remove('active');
      publicInventoryTabContent.classList.remove('hidden');
      publicIssuesTabContent.classList.add('hidden');
    });

    publicIssuesTab.addEventListener('click', function() {
      currentPublicEquipmentTab = 'issues';
      publicIssuesTab.classList.add('active');
      publicInventoryTab.classList.remove('active');
      publicIssuesTabContent.classList.remove('hidden');
      publicInventoryTabContent.classList.add('hidden');
      updatePublicEquipmentIssuesDisplay();
    });

    // T-shirt size field visibility
    equipmentItemSelect.addEventListener('change', function() {
      if (this.value === 'T-shirts') {
        tshirtSizeFields.classList.remove('hidden');
        regularQuantityField.classList.add('hidden');
        document.getElementById('equipmentQuantity').removeAttribute('required');
      } else {
        tshirtSizeFields.classList.add('hidden');
        regularQuantityField.classList.remove('hidden');
        document.getElementById('equipmentQuantity').setAttribute('required', 'required');
      }
    });

    addEquipmentBtn.addEventListener('click', function() {
      equipmentFormContainer.classList.toggle('hidden');
    });

    cancelEquipmentBtn.addEventListener('click', function() {
      equipmentFormContainer.classList.add('hidden');
      equipmentForm.reset();
      tshirtSizeFields.classList.add('hidden');
      regularQuantityField.classList.remove('hidden');
    });

    // Public Area Equipment button handlers
    addPublicEquipmentBtn.addEventListener('click', function() {
      publicEquipmentFormContainer.classList.toggle('hidden');
    });

    cancelPublicEquipmentBtn.addEventListener('click', function() {
      publicEquipmentFormContainer.classList.add('hidden');
      publicEquipmentForm.reset();
    });

    equipmentForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const itemName = equipmentItemSelect.value;
      const purchaseDate = document.getElementById('equipmentPurchaseDate').value;
      const status = document.getElementById('equipmentStatus').value;
      const location = document.getElementById('equipmentLocation').value;
      const notes = document.getElementById('equipmentNotes').value;

      if (!itemName || !purchaseDate || !status) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      submitEquipmentBtn.disabled = true;
      submitEquipmentBtn.innerHTML = '<span class="loading-spinner"></span>Adding...';

      if (itemName === 'T-shirts') {
        // Handle T-shirt sizes separately
        const sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
        let hasQuantity = false;
        for (const size of sizes) {
          const qty = parseInt(document.getElementById(`size${size}`).value) || 0;
          if (qty > 0) {
            hasQuantity = true;
            const newEquipment = {
              id: Date.now().toString() + '-' + size,
              equipment_type: 'housekeeping',
              item_name: `T-shirts (${size})`,
              base_item: 'T-shirts',
              size: size,
              category: equipmentCategoryMap[itemName],
              quantity: qty,
              purchase_date: purchaseDate,
              status: status,
              location: location || null,
              notes: notes || null,
              added_timestamp: new Date().toISOString(),
              issue_description: status === 'broken' || status === 'maintenance' ? 'Initial status' : null,
              issue_reported_date: status === 'broken' || status === 'maintenance' ? new Date().toISOString() : null,
              is_archived: false
            }
            const result = await window.dataSdk.create(newEquipment);
            if (!result.isOk) {
              console.error('Failed to add equipment:', result.error);
            }
          }
        }
        if (!hasQuantity) {
          submitEquipmentBtn.disabled = false;
          submitEquipmentBtn.textContent = 'Add Equipment';
          showToast('Please enter at least one size quantity', 'error');
          return;
        }
      } else {
        // Regular item
        const quantity = parseInt(document.getElementById('equipmentQuantity').value);

        const newEquipment = {
          id: Date.now().toString(),
          equipment_type: 'housekeeping',
          item_name: itemName,
          category: equipmentCategoryMap[itemName],
          quantity: quantity,
          purchase_date: purchaseDate,
          status: status,
          location: location || null,
          notes: notes || null,
          added_timestamp: new Date().toISOString(),
          issue_description: status === 'broken' || status === 'maintenance' ? 'Initial status' : null,
          issue_reported_date: status === 'broken' || status === 'maintenance' ? new Date().toISOString() : null,
          is_archived: false
        };

        const result = await window.dataSdk.create(newEquipment);

        if (!result.isOk) {
          submitEquipmentBtn.disabled = false;
          submitEquipmentBtn.textContent = 'Add Equipment';
          showToast('Failed to add equipment', 'error');
          return;
        }
      }

      submitEquipmentBtn.disabled = false;
      submitEquipmentBtn.textContent = 'Add Equipment';
      equipmentForm.reset();
      equipmentFormContainer.classList.add('hidden');
      tshirtSizeFields.classList.add('hidden');
      regularQuantityField.classList.remove('hidden');
      showToast('Equipment added successfully', 'success');
    });

    // Public Area Equipment form submission
    publicEquipmentForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const itemName = publicEquipmentItemSelect.value;
      const quantity = parseInt(document.getElementById('publicEquipmentQuantity').value);
      const purchaseDate = document.getElementById('publicEquipmentPurchaseDate').value;
      const status = document.getElementById('publicEquipmentStatus').value;
      const location = document.getElementById('publicEquipmentLocation').value;
      const notes = document.getElementById('publicEquipmentNotes').value;

      if (!itemName || !quantity || !purchaseDate || !status) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      submitPublicEquipmentBtn.disabled = true;
      submitPublicEquipmentBtn.innerHTML = '<span class="loading-spinner"></span>Adding...';

      const newEquipment = {
        id: Date.now().toString(),
        equipment_type: 'public_area',
        item_name: itemName,
        category: publicEquipmentCategoryMap[itemName],
        quantity: quantity,
        purchase_date: purchaseDate,
        status: status,
        location: location || null,
        notes: notes || null,
        added_timestamp: new Date().toISOString(),
        issue_description: status === 'broken' || status === 'maintenance' ? 'Initial status' : null,
        issue_reported_date: status === 'broken' || status === 'maintenance' ? new Date().toISOString() : null,
        is_archived: false
      };

      const result = await window.dataSdk.create(newEquipment);

      submitPublicEquipmentBtn.disabled = false;
      submitPublicEquipmentBtn.textContent = 'Add Equipment';

      if (!result.isOk) {
        showToast('Failed to add equipment', 'error');
        return;
      }

      publicEquipmentForm.reset();
      publicEquipmentFormContainer.classList.add('hidden');
      showToast('Equipment added successfully', 'success');
    });

    function calculateEquipmentAge(purchaseDate) {
      const now = new Date();
      const purchase = new Date(purchaseDate);
      const diffTime = Math.abs(now - purchase);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 30) {
        return `${diffDays} days`;
      } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        return months === 1 ? '1 month' : `${months} months`;
      } else {
        const years = Math.floor(diffDays / 365);
        const months = Math.floor((diffDays % 365) / 30);
        if (months === 0) {
          return years === 1 ? '1 year' : `${years} years`;
        }
        const yearText = years === 1 ? '1 year' : `${years} years`;
        const monthText = months === 1 ? '1 month' : `${months} months`;
        return `${yearText}, ${monthText}`;
      }
    }

    function updateEquipmentDisplay() {
      const container = document.getElementById('equipmentInventoryContainer');

      if (allEquipment.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ­</div>
            <div class="empty-title">No equipment in inventory yet</div>
            <div class="empty-subtitle">Add your first equipment item to get started</div>
          </div>
        `;
        return;
      }

      // Group by category
      const groupedByCategory = {};
      allEquipment.forEach(equip => {
        const category = equip.category;
        if (!groupedByCategory[category]) {
          groupedByCategory[category] = [];
        }
        groupedByCategory[category].push(equip);
      });

      const categoryOrder = [
        'ğŸ‘• Uniform & PPE',
        'ğŸ§¹ Cleaning Tools',
        'ğŸšš Equipment & Trolleys',
        'ğŸ§º Laundry & Waste',
        'ğŸŒ€ Machines & Accessories'
      ];

      container.innerHTML = categoryOrder
        .filter(cat => groupedByCategory[cat])
        .map(category => {
          const items = groupedByCategory[category];
          const icon = equipmentCategoryIcons[category];

          return `
            <div class="equipment-category-section">
              <div class="category-banner" onclick="toggleEquipmentCategory('${category.replace(/[^a-z0-9]/gi, '')}')">
                <div class="category-banner-left">
                  <span class="expand-arrow" id="arrow-${category.replace(/[^a-z0-9]/gi, '')}">â–¶</span>
                  <span class="category-icon">${icon}</span>
                  <span class="category-title">${category}</span>
                  <span class="item-count-badge">${items.length} items</span>
                </div>
              </div>
              <div class="notifications-list" id="list-${category.replace(/[^a-z0-9]/gi, '')}">
                ${items.map(equip => createEquipmentCard(equip)).join('')}
              </div>
            </div>
          `;
        })
        .join('');

      // Attach event listeners
      allEquipment.forEach(equip => {
        const reportBtn = document.getElementById(`report-issue-${equip.id}`);
        const markWorkingBtn = document.getElementById(`mark-working-${equip.id}`);
        const deleteBtn = document.getElementById(`delete-equip-${equip.id}`);

        if (reportBtn) {
          reportBtn.addEventListener('click', () => reportEquipmentIssue(equip));
        }
        if (markWorkingBtn) {
          markWorkingBtn.addEventListener('click', () => markEquipmentWorking(equip));
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteEquipment(equip));
        }
      });

      // Preserve tab state after display update
      if (currentEquipmentTab === 'issues') {
        inventoryTabContent.classList.add('hidden');
        issuesTabContent.classList.remove('hidden');
        updateEquipmentIssuesDisplay();
      } else {
        inventoryTabContent.classList.remove('hidden');
        issuesTabContent.classList.add('hidden');
      }
    }

    function updatePublicEquipmentDisplay() {
      const container = document.getElementById('publicEquipmentInventoryContainer');

      if (allPublicEquipment.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ­</div>
            <div class="empty-title">No equipment in inventory yet</div>
            <div class="empty-subtitle">Add your first equipment item to get started</div>
          </div>
        `;
        return;
      }

      // Group by category
      const groupedByCategory = {};
      allPublicEquipment.forEach(equip => {
        const category = equip.category;
        if (!groupedByCategory[category]) {
          groupedByCategory[category] = [];
        }
        groupedByCategory[category].push(equip);
      });

      const categoryOrder = [
        'âš ï¸ Safety',
        'ğŸš¬ Outside / Entrance',
        'ğŸš» Public Toilets',
        'â™¿ Accessible Toilet',
        'ğŸ§¹ Cleaning Equipment'
      ];

      container.innerHTML = categoryOrder
        .filter(cat => groupedByCategory[cat])
        .map(category => {
          const items = groupedByCategory[category];
          const icon = publicEquipmentCategoryIcons[category];

          return `
            <div class="equipment-category-section">
              <div class="category-banner" onclick="togglePublicEquipmentCategory('${category.replace(/[^a-z0-9]/gi, '')}')">
                <div class="category-banner-left">
                  <span class="expand-arrow" id="arrow-public-${category.replace(/[^a-z0-9]/gi, '')}">â–¶</span>
                  <span class="category-icon">${icon}</span>
                  <span class="category-title">${category}</span>
                  <span class="item-count-badge">${items.length} items</span>
                </div>
              </div>
              <div class="notifications-list" id="list-public-${category.replace(/[^a-z0-9]/gi, '')}">
                ${items.map(equip => createPublicEquipmentCard(equip)).join('')}
              </div>
            </div>
          `;
        })
        .join('');

      // Attach event listeners
      allPublicEquipment.forEach(equip => {
        const reportBtn = document.getElementById(`report-issue-public-${equip.id}`);
        const markWorkingBtn = document.getElementById(`mark-working-public-${equip.id}`);
        const deleteBtn = document.getElementById(`delete-equip-public-${equip.id}`);

        if (reportBtn) {
          reportBtn.addEventListener('click', () => reportPublicEquipmentIssue(equip));
        }
        if (markWorkingBtn) {
          markWorkingBtn.addEventListener('click', () => markPublicEquipmentWorking(equip));
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deletePublicEquipment(equip));
        }
      });

      // Preserve tab state after display update
      if (currentPublicEquipmentTab === 'issues') {
        publicInventoryTabContent.classList.add('hidden');
        publicIssuesTabContent.classList.remove('hidden');
        updatePublicEquipmentIssuesDisplay();
      } else {
        publicInventoryTabContent.classList.remove('hidden');
        publicIssuesTabContent.classList.add('hidden');
      }
    }

    function createEquipmentCard(equip) {
      const statusBadgeClass = equip.status === 'working' ? 'working' : equip.status === 'broken' ? 'broken' : 'maintenance';
      const statusText = equip.status === 'working' ? 'ğŸŸ¢ Working' : equip.status === 'broken' ? 'ğŸ”´ Broken' : 'ğŸŸ¡ Maintenance';
      const cardClass = equip.status === 'broken' ? 'equipment-card status-broken' : equip.status === 'maintenance' ? 'equipment-card status-maintenance' : 'equipment-card';
      
      const purchaseFormatted = new Date(equip.purchase_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
      });

      const age = calculateEquipmentAge(equip.purchase_date);

      let actionButtons = '';
      if (equip.status === 'working') {
        actionButtons = `
          <button class="btn-report-issue" id="report-issue-${equip.id}">âš ï¸ Report Issue</button>
          <button class="btn-delete" id="delete-equip-${equip.id}">ğŸ—‘ï¸ Delete</button>
        `;
      } else {
        actionButtons = `
          <button class="btn-mark-working" id="mark-working-${equip.id}">âœ… Mark as Working</button>
          <button class="btn-delete" id="delete-equip-${equip.id}">ğŸ—‘ï¸ Delete</button>
        `;
      }

      return `
        <div class="${cardClass}">
          <div class="equipment-header">
            <div>
              <div class="equipment-name">${equip.item_name}</div>
            </div>
            <span class="equipment-status-badge ${statusBadgeClass}">${statusText}</span>
          </div>
          <div class="equipment-details">
            <div class="equipment-detail"><strong>ğŸ“… Purchase Date:</strong> ${purchaseFormatted}</div>
            <div class="equipment-detail"><strong>â³ Age:</strong> ${age}</div>
            <div class="equipment-detail"><strong>ğŸ“¦ Amount:</strong> ${equip.quantity}</div>
            ${equip.location ? `<div class="equipment-detail"><strong>ğŸ“ Location:</strong> ${equip.location}</div>` : ''}
            ${equip.notes ? `<div class="equipment-detail"><strong>ğŸ“ Notes:</strong> ${equip.notes}</div>` : ''}
            ${equip.issue_description && equip.status !== 'working' ? `<div class="equipment-detail"><strong>ğŸ”§ Issue:</strong> ${equip.issue_description}</div>` : ''}
          </div>
          <div class="equipment-actions">
            ${actionButtons}
          </div>
        </div>
      `;
    }

    function createPublicEquipmentCard(equip) {
      const statusBadgeClass = equip.status === 'working' ? 'working' : equip.status === 'broken' ? 'broken' : 'maintenance';
      const statusText = equip.status === 'working' ? 'ğŸŸ¢ Working' : equip.status === 'broken' ? 'ğŸ”´ Broken' : 'ğŸŸ¡ Maintenance';
      const cardClass = equip.status === 'broken' ? 'equipment-card status-broken' : equip.status === 'maintenance' ? 'equipment-card status-maintenance' : 'equipment-card';
      
      const purchaseFormatted = new Date(equip.purchase_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
      });

      const age = calculateEquipmentAge(equip.purchase_date);

      let actionButtons = '';
      if (equip.status === 'working') {
        actionButtons = `
          <button class="btn-report-issue" id="report-issue-public-${equip.id}">âš ï¸ Report Issue</button>
          <button class="btn-delete" id="delete-equip-public-${equip.id}">ğŸ—‘ï¸ Delete</button>
        `;
      } else {
        actionButtons = `
          <button class="btn-mark-working" id="mark-working-public-${equip.id}">âœ… Mark as Working</button>
          <button class="btn-delete" id="delete-equip-public-${equip.id}">ğŸ—‘ï¸ Delete</button>
        `;
      }

      return `
        <div class="${cardClass}">
          <div class="equipment-header">
            <div>
              <div class="equipment-name">${equip.item_name}</div>
            </div>
            <span class="equipment-status-badge ${statusBadgeClass}">${statusText}</span>
          </div>
          <div class="equipment-details">
            <div class="equipment-detail"><strong>ğŸ“… Purchase Date:</strong> ${purchaseFormatted}</div>
            <div class="equipment-detail"><strong>â³ Age:</strong> ${age}</div>
            <div class="equipment-detail"><strong>ğŸ“¦ Amount:</strong> ${equip.quantity}</div>
            ${equip.location ? `<div class="equipment-detail"><strong>ğŸ“ Location:</strong> ${equip.location}</div>` : ''}
            ${equip.notes ? `<div class="equipment-detail"><strong>ğŸ“ Notes:</strong> ${equip.notes}</div>` : ''}
            ${equip.issue_description && equip.status !== 'working' ? `<div class="equipment-detail"><strong>ğŸ”§ Issue:</strong> ${equip.issue_description}</div>` : ''}
          </div>
          <div class="equipment-actions">
            ${actionButtons}
          </div>
        </div>
      `;
    }

    async function reportEquipmentIssue(equip) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Report Issue - ${equip.item_name}</div>
          <form id="reportIssueForm">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label" for="issueDescription">Issue Description *</label>
              <textarea class="form-input" id="issueDescription" placeholder="Describe the issue..." rows="3" required style="resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label class="form-label" for="issueLocation">Location (Optional)</label>
              <input type="text" class="form-input" id="issueLocation" placeholder="Where is the equipment?" value="${equip.location || ''}">
            </div>
            <div class="modal-buttons">
              <button type="button" class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-modal-confirm" style="background: #dc3545; border-color: #dc3545;">Report Issue</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('reportIssueForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const description = document.getElementById('issueDescription').value;
        const location = document.getElementById('issueLocation').value;

        const result = await window.dataSdk.update({
          ...equip,
          status: 'broken',
          issue_description: description,
          issue_reported_date: new Date().toISOString(),
          location: location || equip.location
        });

        closeModal();
        
        if (result.isOk) {
          const today = getLocalDateString();
          const notification = {
            id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            type: 'broken',
            item_name: equip.item_name,
            source: 'Housekeeping Equipment',
            location: location || equip.location || 'N/A',
            description: description,
            added_timestamp: new Date().toISOString(),
            date_added: today,
            is_archived: false
          };
          const notifResult = await window.dataSdk.create(notification);
          if (!notifResult.isOk) {
            console.error('Failed to create notification:', notifResult.error);
          }
          showToast('Issue reported successfully', 'success');
        } else {
          showToast('Failed to report issue', 'error');
        }
      });
    }

    async function reportPublicEquipmentIssue(equip) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Report Issue - ${equip.item_name}</div>
          <form id="reportPublicIssueForm">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label class="form-label" for="publicIssueDescription">Issue Description *</label>
              <textarea class="form-input" id="publicIssueDescription" placeholder="Describe the issue..." rows="3" required style="resize: vertical;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label class="form-label" for="publicIssueLocation">Location (Optional)</label>
              <input type="text" class="form-input" id="publicIssueLocation" placeholder="Where is the equipment?" value="${equip.location || ''}">
            </div>
            <div class="modal-buttons">
              <button type="button" class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
              <button type="submit" class="btn-modal-confirm" style="background: #dc3545; border-color: #dc3545;">Report Issue</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('reportPublicIssueForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const description = document.getElementById('publicIssueDescription').value;
        const location = document.getElementById('publicIssueLocation').value;

        const result = await window.dataSdk.update({
          ...equip,
          status: 'broken',
          issue_description: description,
          issue_reported_date: new Date().toISOString(),
          location: location || equip.location
        });

        closeModal();
        
        if (result.isOk) {
          const today = getLocalDateString();
          const notification = {
            id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
            type: 'broken',
            item_name: equip.item_name,
            source: 'Public Area Equipment',
            location: location || equip.location || 'N/A',
            description: description,
            added_timestamp: new Date().toISOString(),
            date_added: today,
            is_archived: false
          };
          const notifResult = await window.dataSdk.create(notification);
          if (!notifResult.isOk) {
            console.error('Failed to create notification:', notifResult.error);
          }
          showToast('Issue reported successfully', 'success');
        } else {
          showToast('Failed to report issue', 'error');
        }
      });
    }

    async function markEquipmentWorking(equip) {
      const btn = document.getElementById(`mark-working-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Updating...';

      const result = await window.dataSdk.update({
        ...equip,
        status: 'working',
        issue_description: null,
        issue_reported_date: null
      });

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'âœ… Mark as Working';
        showToast('Failed to update status', 'error');
      } else {
        showToast('Status updated successfully', 'success');
      }
    }

    async function markPublicEquipmentWorking(equip) {
      const btn = document.getElementById(`mark-working-public-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Updating...';

      const result = await window.dataSdk.update({
        ...equip,
        status: 'working',
        issue_description: null,
        issue_reported_date: null
      });

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'âœ… Mark as Working';
        showToast('Failed to update status', 'error');
      } else {
        showToast('Status updated successfully', 'success');
      }
    }

    async function deleteEquipment(equip) {
      const btn = document.getElementById(`delete-equip-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(equip);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete equipment', 'error');
      }
    }

    async function deletePublicEquipment(equip) {
      const btn = document.getElementById(`delete-equip-public-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(equip);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete equipment', 'error');
      }
    }

    window.toggleEquipmentCategory = function(categoryId) {
      const arrow = document.getElementById(`arrow-${categoryId}`);
      const list = document.getElementById(`list-${categoryId}`);
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    };

    window.togglePublicEquipmentCategory = function(categoryId) {
      const arrow = document.getElementById(`arrow-public-${categoryId}`);
      const list = document.getElementById(`list-public-${categoryId}`);
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    };

    function updateEquipmentIssuesDisplay() {
      const container = document.getElementById('equipmentIssuesContainer');
      const issues = allEquipment.filter(e => e.status === 'broken' || e.status === 'maintenance');

      if (issues.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âœ…</div>
            <div class="empty-title">No active issues</div>
            <div class="empty-subtitle">All equipment is working properly</div>
          </div>
        `;
        return;
      }

      container.innerHTML = issues.map(equip => createIssueCard(equip)).join('');

      // Attach event listeners
      issues.forEach(equip => {
        const resolveBtn = document.getElementById(`resolve-issue-${equip.id}`);
        const deleteBtn = document.getElementById(`delete-issue-${equip.id}`);

        if (resolveBtn) {
          resolveBtn.addEventListener('click', () => resolveIssue(equip));
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteEquipment(equip));
        }
      });
    }

    function updatePublicEquipmentIssuesDisplay() {
      const container = document.getElementById('publicEquipmentIssuesContainer');
      const issues = allPublicEquipment.filter(e => e.status === 'broken' || e.status === 'maintenance');

      if (issues.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">   </div>
            <div class="empty-title">No active issues</div>
            <div class="empty-subtitle">All equipment is working properly</div>
          </div>
        `;
        return;
      }

      container.innerHTML = issues.map(equip => createPublicIssueCard(equip)).join('');

      // Attach event listeners
      issues.forEach(equip => {
        const resolveBtn = document.getElementById(`resolve-issue-public-${equip.id}`);
        const deleteBtn = document.getElementById(`delete-issue-public-${equip.id}`);

        if (resolveBtn) {
          resolveBtn.addEventListener('click', () => resolvePublicIssue(equip));
        }
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deletePublicEquipment(equip));
        }
      });
    }

    function createIssueCard(equip) {
      const reportedDate = equip.issue_reported_date ? new Date(equip.issue_reported_date) : null;
      const reportedFormatted = reportedDate ? reportedDate.toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      }) : 'N/A';

      const daysSince = reportedDate ? Math.floor((new Date() - reportedDate) / (1000 * 60 * 60 * 24)) : 0;
      const daysText = daysSince === 0 ? 'Today' : daysSince === 1 ? '1 day ago' : `${daysSince} days ago`;

      const age = calculateEquipmentAge(equip.purchase_date);

      return `
        <div class="issue-card">
          <div class="issue-header">
            <span class="issue-icon">âš ï¸</span>
            <span class="issue-title">${equip.item_name}</span>
          </div>
          <div class="issue-details">
            <div class="issue-detail"><strong>ğŸ·ï¸ Category:</strong> ${equip.category}</div>
            <div class="issue-detail"><strong>ğŸ“ Issue:</strong> ${equip.issue_description || 'No description'}</div>
            <div class="issue-detail"><strong>ğŸ“ Location:</strong> ${equip.location || 'Not specified'}</div>
            <div class="issue-detail"><strong>ğŸ“… Reported:</strong> ${reportedFormatted} (${daysText})</div>
            <div class="issue-detail"><strong>â³ Equipment Age:</strong> ${age}</div>
          </div>
          <div class="issue-actions">
            <button class="btn-resolve-issue" id="resolve-issue-${equip.id}">âœ… Resolve Issue</button>
            <button class="btn-delete" id="delete-issue-${equip.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    function createPublicIssueCard(equip) {
      const reportedDate = equip.issue_reported_date ? new Date(equip.issue_reported_date) : null;
      const reportedFormatted = reportedDate ? reportedDate.toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      }) : 'N/A';

      const daysSince = reportedDate ? Math.floor((new Date() - reportedDate) / (1000 * 60 * 60 * 24)) : 0;
      const daysText = daysSince === 0 ? 'Today' : daysSince === 1 ? '1 day ago' : `${daysSince} days ago`;

      const age = calculateEquipmentAge(equip.purchase_date);

      return `
        <div class="issue-card">
          <div class="issue-header">
            <span class="issue-icon">âš ï¸</span>
            <span class="issue-title">${equip.item_name}</span>
          </div>
          <div class="issue-details">
            <div class="issue-detail"><strong>ğŸ·ï¸ Category:</strong> ${equip.category}</div>
            <div class="issue-detail"><strong>ğŸ“ Issue:</strong> ${equip.issue_description || 'No description'}</div>
            <div class="issue-detail"><strong>ğŸ“ Location:</strong> ${equip.location || 'Not specified'}</div>
            <div class="issue-detail"><strong>ğŸ“… Reported:</strong> ${reportedFormatted} (${daysText})</div>
            <div class="issue-detail"><strong>â³ Equipment Age:</strong> ${age}</div>
          </div>
          <div class="issue-actions">
            <button class="btn-resolve-issue" id="resolve-issue-public-${equip.id}">âœ… Resolve Issue</button>
            <button class="btn-delete" id="delete-issue-public-${equip.id}">  ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    async function resolveIssue(equip) {
      const btn = document.getElementById(`resolve-issue-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Resolving...';

      const result = await window.dataSdk.update({
        ...equip,
        status: 'working',
        issue_description: null,
        issue_reported_date: null
      });

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'âœ… Resolve Issue';
        showToast('Failed to resolve issue', 'error');
      } else {
        showToast('Issue resolved successfully', 'success');
      }
    }

    async function resolvePublicIssue(equip) {
      const btn = document.getElementById(`resolve-issue-public-${equip.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Resolving...';

      const result = await window.dataSdk.update({
        ...equip,
        status: 'working',
        issue_description: null,
        issue_reported_date: null
      });

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'âœ… Resolve Issue';
        showToast('Failed to resolve issue', 'error');
      } else {
        showToast('Issue resolved successfully', 'success');
      }
    }

    // ============== STOCK COUNTER FUNCTIONALITY ==============

    const displayNumber = document.getElementById('displayNumber');
    const displayArea = document.getElementById('displayArea');
    const floorSelect = document.getElementById('floorSelect');
    const stockItemSelect = document.getElementById('stockItemSelect');
    const saveStockBtn = document.getElementById('saveStockBtn');

    // Number pad buttons
    document.querySelectorAll('.num-button[data-num]').forEach(btn => {
      btn.addEventListener('click', function() {
        const num = this.getAttribute('data-num');
        currentStockValue = parseInt(currentStockValue.toString() + num);
        displayNumber.textContent = currentStockValue;
      });
    });

    // Backspace button
    const backspaceBtn = document.querySelector('.num-button[data-action="backspace"]');
    if (backspaceBtn) {
      backspaceBtn.addEventListener('click', function() {
        const str = currentStockValue.toString();
        currentStockValue = str.length > 1 ? parseInt(str.slice(0, -1)) : 0;
        displayNumber.textContent = currentStockValue;
      });
    }

    // Display area click to clear
    if (displayArea) {
      displayArea.addEventListener('click', function() {
        currentStockValue = 0;
        displayNumber.textContent = '0';
      });
    }

    // Quick buttons
    document.querySelectorAll('.quick-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const value = parseInt(this.getAttribute('data-quick'));
        currentStockValue = value;
        displayNumber.textContent = currentStockValue;
      });
    });

    // Save stock item
    saveStockBtn.addEventListener('click', async function() {
      const floor = floorSelect.value;
      const itemName = stockItemSelect.value;
      const quantity = currentStockValue;

      if (!floor || !itemName) {
        showToast('Please select floor and item', 'error');
        return;
      }

      saveStockBtn.disabled = true;
      saveStockBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';

      const today = getLocalDateString();

      // Check if we need to auto-archive old stock counts
      const todayStockCounts = allStockCounts.filter(item => item.date_added === today);
      if (allStockCounts.length > 0 && todayStockCounts.length === 0) {
        // Auto-archive all existing stock counts
        for (const item of allStockCounts) {
          const archiveResult = await window.dataSdk.update({
            ...item,
            is_archived: true
          });
          if (!archiveResult.isOk) {
            console.error("Failed to archive stock count:", archiveResult.error);
          }
        }
      }

      const newStockCount = {
        id: Date.now().toString(),
        stock_type: 'minibar_count',
        item_name: itemName,
        floor: floor,
        quantity: quantity,
        added_timestamp: new Date().toISOString(),
        date_added: today,
        is_archived: false
      };

      const result = await window.dataSdk.create(newStockCount);

      saveStockBtn.disabled = false;
      saveStockBtn.textContent = '    Save This Item';

      if (result.isOk) {
        // Reset for next entry - but keep item selected
        currentStockValue = 0;
        displayNumber.textContent = '0';
        // stockItemSelect.value stays the same - removed reset
        showToast(`${itemName} saved for ${floor}`, 'success');

        // Check for low stock and create notification
        await checkLowStockAndNotify(itemName, today);
      } else {
        showToast('Failed to save item. Please try again.', 'error');
      }
    });

    async function checkLowStockAndNotify(itemName, date) {
      // Get all counts for this item on this date
      const itemCounts = allStockCounts.filter(sc => 
        sc.item_name === itemName && sc.date_added === date
      );

      // Calculate totals per floor
      const totals = {
        F1: 0,
        F2: 0,
        F3: 0,
        Office: 0
      };

      itemCounts.forEach(count => {
        if (totals[count.floor] !== undefined) {
          totals[count.floor] += count.quantity;
        }
      });

      const totalStock = totals.F1 + totals.F2 + totals.F3 + totals.Office;

      // If total stock is under 40, create low stock notification
      if (totalStock < 40) {
        const orderQty = Math.max(0, 40 - totalStock);

        // Check if notification already exists for this item today
        const existingNotif = allNotifications.find(n => 
          n.type === 'low_stock' && 
          n.item_name === itemName && 
          n.date_added === date
        );

        if (existingNotif) {
          // Update existing notification
          await window.dataSdk.update({
            ...existingNotif,
            stock_f1: totals.F1,
            stock_f2: totals.F2,
            stock_f3: totals.F3,
            stock_office: totals.Office,
            total_stock: totalStock,
            order_quantity: orderQty
          });
        } else {
          // Create new notification
          const newNotification = {
            id: Date.now().toString() + '-lowstock',
            type: 'low_stock',
            item_name: itemName,
            source: 'Minibar Stock',
            stock_f1: totals.F1,
            stock_f2: totals.F2,
            stock_f3: totals.F3,
            stock_office: totals.Office,
            total_stock: totalStock,
            order_quantity: orderQty,
            added_timestamp: new Date().toISOString(),
            date_added: date,
            is_archived: false
          };

          await window.dataSdk.create(newNotification);
          showToast(`Low stock alert created for ${itemName}`, 'success');
        }
      }
    }

    function updateStockProgress() {
      const today = getLocalDateString();
      const todayCount = allStockCounts.filter(sc => sc.date_added === today).length;
      
      // Calculate total unique items that need counting (20 items across 4 floors = 80 max)
      const uniqueItems = new Set(allStockCounts.filter(sc => sc.date_added === today).map(sc => `${sc.floor}-${sc.item_name}`));
      
      document.getElementById('stockProgress').textContent = 
        `Progress: ${uniqueItems.size}/80 items entered âœ“`;
      
      updateTodayStockBanner();
    }

    function updateTodayStockBanner() {
      const bannerContainer = document.getElementById('todayStockCountBanner');
      const today = getLocalDateString();
      const todayCounts = allStockCounts.filter(sc => sc.date_added === today);

      if (todayCounts.length === 0) {
        bannerContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div class="empty-title">No items counted yet</div>
            <div class="empty-subtitle">Start counting items above and they'll appear here</div>
          </div>
        `;
        return;
      }

      const formattedDate = new Date(today).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      bannerContainer.innerHTML = `
        <div class="date-group">
          <div class="date-banner" onclick="toggleStockBanner()">
            <div class="date-banner-left">
              <span class="expand-arrow" id="arrow-stock-today">â–¶</span>
              <span class="date-title">${formattedDate}</span>
              <span class="item-count-badge">${todayCounts.length} entries</span>
            </div>
            <div class="date-banner-actions">
              <button class="btn-save-pdf" onclick="event.stopPropagation(); saveActiveStockCountPDF('${today}')">ğŸ“¥ Save PDF</button>
              <button class="btn-archive" onclick="event.stopPropagation(); confirmArchiveStockGroup('${today}', ${todayCounts.length})">ğŸ“ Archive All</button>
              <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteStockGroup('${today}', ${todayCounts.length})">ğŸ—‘ï¸ Delete All</button>
            </div>
          </div>
          <div class="notifications-list" id="list-stock-today">
            ${todayCounts.map(count => createStockCountCard(count)).join('')}
          </div>
        </div>
      `;

      // Attach delete listeners
      todayCounts.forEach(count => {
        const deleteBtn = document.getElementById(`delete-stock-${count.id}`);
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteStockCount(count));
        }
      });
    }

    async function deleteStockCount(count) {
      const btn = document.getElementById(`delete-stock-${count.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(count);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = '  ï¸ Delete';
        showToast('Failed to delete item', 'error');
      }
    }

    window.toggleStockBanner = function() {
      const arrow = document.getElementById('arrow-stock-today');
      const list = document.getElementById('list-stock-today');
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    };

    // ============== ROOM REGISTRY FUNCTIONALITY ==============

    roomRegistryContainer = document.getElementById('roomRegistryContainer');
    roomDetailContainer = document.getElementById('roomDetailContainer');
    maintenanceQueueBtn = document.getElementById('maintenanceQueueBtn');
    maintenanceList = document.getElementById('maintenanceList');
    maintenanceCount = document.getElementById('maintenanceCount');

    let currentRoomNumber = null;

    const roomFloors = [
      { name: 'Floor 1', rooms: Array.from({ length: 15 }, (_, i) => 101 + i) },
      { name: 'Floor 2', rooms: Array.from({ length: 15 }, (_, i) => 201 + i) },
      { name: 'Floor 3', rooms: Array.from({ length: 13 }, (_, i) => 301 + i) }
    ];

    const roomTemplate = [
      {
        category: 'Furniture',
        items: [
          { name: 'Bed', qty: false },
          { name: 'Mattress', qty: false },
          { name: 'Bed Frame', qty: false },
          { name: 'Headboard', qty: false },
          { name: 'Nightstands', qty: true },
          { name: 'Wardrobe', qty: false },
          { name: 'Dresser', qty: false },
          { name: 'Desk with Desk Chair', qty: false },
          { name: 'Luggage Rack', qty: false },
          { name: 'Lounge Chair', qty: true },
          { name: 'Sofa', qty: true },
          { name: 'Coffee Table', qty: false },
          { name: 'Side Table', qty: false }
        ]
      },
      {
        category: 'Mirrors',
        items: [
          { name: 'Full-length Mirror', qty: false },
          { name: 'Decorative Mirror', qty: true }
        ]
      },
      {
        category: 'Electronics & Appliances',
        items: [
          { name: 'TV with Wall Mount', qty: false },
          { name: 'Marshall Speaker', qty: false },
          { name: 'Table Lamp', qty: false },
          { name: 'Nespresso Machine', qty: false },
          { name: 'Teakettle', qty: false },
          { name: 'Floor Fan', qty: false },
          { name: 'Telephone', qty: false },
          { name: 'Safe', qty: false }
        ]
      },
      {
        category: 'Minibar Items & Accessories',
        items: [
          { name: 'Minibar', qty: false },
          { name: 'Wine Glasses', qty: true },
          { name: 'Tumblers', qty: true },
          { name: 'Wine Opener', qty: true },
          { name: 'Minibar Menu', qty: false },
          { name: 'Frame', qty: false },
          { name: 'Coffee Cups', qty: true },
          { name: 'Teaspoons', qty: true },
          { name: 'Coffee Capsule Display', qty: false },
          { name: 'Coffee Menu', qty: false },
          { name: 'Tea Box', qty: false },
          { name: 'Tea & Coffee Tray', qty: false }
        ]
      },
      {
        category: 'Bedding',
        items: [
          { name: 'Duvet', qty: false },
          { name: 'Mattress Protector', qty: false },
          { name: 'Soft Pillows', qty: true },
          { name: 'Hard Pillows', qty: true }
        ]
      },
      {
        category: 'Bathroom Items',
        items: [
          { name: 'Shower Caddy', qty: false },
          { name: 'Bottle Holder (Shower)', qty: false },
          { name: 'Bottle Holder (Sink)', qty: false },
          { name: 'Vanity Box', qty: false },
          { name: 'Towel Heater', qty: false },
          { name: 'Hairdryer', qty: false },
          { name: 'Bin with Lid', qty: false },
          { name: 'Tissue Box Holder', qty: false },
          { name: 'WC Brush', qty: false }
        ]
      },
      {
        category: 'Miscellaneous',
        items: [
          { name: 'Waste Bin', qty: false },
          { name: 'Hangers', qty: true },
          { name: 'Notepad and Pen', qty: false },
          { name: 'Hotel Information Booklet', qty: false },
          { name: 'Hotel Information Booklet Holder', qty: false },
          { name: 'Wooden DND Card', qty: false },
          { name: 'Wooden HFT Card', qty: false },
          { name: 'Water Bottle', qty: false }
        ]
      }
    ];

    const roomSetupCustomItems = {};

    function getRoomItems(roomNumber) {
      return roomItems.filter(item => String(item.room_number) === String(roomNumber));
    }

    function getRoomIssues(items) {
      return items.filter(item => item.status && item.status !== 'good');
    }

    function renderRoomRegistry() {
      if (!roomRegistryContainer || !roomDetailContainer) return;
      if (currentPage !== 'room-registry') {
        updateMaintenanceCount();
        return;
      }

      roomRegistryContainer.classList.remove('hidden');
      roomDetailContainer.classList.add('hidden');

      roomRegistryContainer.innerHTML = roomFloors.map(floor => {
        const roomsMarkup = floor.rooms.map(roomNumber => {
          const items = getRoomItems(roomNumber);
          const issues = getRoomIssues(items);
          const hasItems = items.length > 0;
          const hasIssues = issues.length > 0;
          const statusLabel = hasItems
            ? (hasIssues ? `${issues.length} Issues` : 'All Good')
            : 'Not Setup';
          const icon = hasIssues ? 'âš ï¸' : (hasItems ? 'ğŸ“¦' : 'âšª');
          const preview = hasIssues
            ? issues[0].item_name
            : (hasItems ? 'All good' : 'Not setup');

          return `
            <div class="storage-card storage-card-v2 ${hasItems ? 'has-items' : ''}" data-room="${roomNumber}">
              <div class="storage-icon">${icon}</div>
              <div class="storage-id">${roomNumber}</div>
              <div class="storage-status">${statusLabel}</div>
              <div class="storage-preview">${preview}</div>
            </div>
          `;
        }).join('');

        return `
          <div class="room-section" style="margin-bottom: 2rem;">
            <div class="room-section-title playfair" style="font-size: 1.5rem; color: #d4af37; margin-bottom: 1rem;">${floor.name}</div>
            <div class="storage-grid">${roomsMarkup}</div>
          </div>
        `;
      }).join('');

      roomRegistryContainer.querySelectorAll('[data-room]').forEach(card => {
        card.addEventListener('click', () => {
          const roomNumber = card.getAttribute('data-room');
          openRoomDetail(roomNumber);
        });
      });

      updateMaintenanceCount();
    }

    function openRoomDetail(roomNumber) {
      currentRoomNumber = roomNumber;
      if (!roomRegistryContainer || !roomDetailContainer) return;
      roomRegistryContainer.classList.add('hidden');
      roomDetailContainer.classList.remove('hidden');
      renderRoomDetail(roomNumber);
    }

    function renderRoomDetail(roomNumber) {
      const items = getRoomItems(roomNumber);
      const header = `
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
          <div style="font-size: 1.5rem; font-weight: 700; color: #d4af37;">Room ${roomNumber}</div>
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button class="btn-cancel" id="backToRoomsBtn">â¬… Back to Rooms</button>
            <button class="btn-submit" id="checkRoomBtn">âœ… Mark as Checked Now</button>
            <button class="btn-submit" id="addCustomRoomItemBtn">â• Add Custom Item</button>
          </div>
        </div>
      `;

      if (items.length === 0) {
        const customItems = roomSetupCustomItems[roomNumber] || [];
        const setupSections = [...roomTemplate, { category: 'Custom Items', items: customItems }].map(section => {
          const categoryKey = section.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          const itemsHtml = section.items.length
            ? section.items.map((item, index) => {
              const checkboxId = `check_${categoryKey}_${index + 1}`;
              const qtyId = `qty_${categoryKey}_${index + 1}`;
              return `
                <div class="checklist-item" style="color: #f4e4a8; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.2rem; border-radius: 999px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(212, 175, 55, 0.6); box-shadow: 0 12px 26px rgba(2, 6, 15, 0.3); width: 100%; flex-wrap: nowrap;">
                  <input class="checklist-checkbox" type="checkbox" id="${checkboxId}" name="items" value="${section.category}|${item.name}|${item.qty ? 'true' : 'false'}" data-item="${item.name}" data-category="${section.category}">
                  <label class="checklist-label" for="${checkboxId}" style="color: #f4e4a8; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</label>
                  ${item.qty ? `
                    <div class="checklist-qty" style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0.7rem; border-radius: 999px; background: rgba(11, 26, 51, 0.95); border: 1px solid rgba(212, 175, 55, 0.5);">
                      <span style="color: #f4e4a8;">Qty:</span>
                      <input type="number" id="${qtyId}" min="1" value="1" data-qty-for="${checkboxId}" style="border-radius: 999px; border: 2px solid rgba(212, 175, 55, 0.7); background: rgba(10, 17, 40, 0.95); color: #d4af37; text-align: center; width: 5.5rem; padding: 0.5rem;">
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')
            : `<div style="color: #f4e4a8; opacity: 0.7;">No custom items yet.</div>`;

          return `
            <div class="setup-category">
              <div class="setup-category-title playfair">${section.category} (${section.items.length} items)</div>
              <div class="checklist-items">${itemsHtml}</div>
            </div>
          `;
        }).join('');

        roomDetailContainer.innerHTML = `
          <div class="setup-container" style="color: #f4e4a8;">
            <div class="setup-back">
              <button class="btn-cancel" id="backToRoomsBtn">â† Back to Room Registry</button>
            </div>
            <div class="setup-title playfair">Setup Room ${roomNumber}</div>
            <div class="setup-subtitle" style="color: #f4e4a8;">Select items present in this room from the checklist below</div>

            <div class="setup-add-btn">
              <button class="btn-submit" id="showCustomItemFormBtn">â• Add Custom Item to Checklist</button>
            </div>

            <div class="setup-form hidden" id="customItemForm">
              <div class="setup-form-title playfair">Add Custom Item to Checklist</div>
              <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                  <label for="customItemName">Item Name</label>
                  <input type="text" id="customItemName" placeholder="e.g., Artwork, Decorative Vase, Extra Furniture" required>
                </div>
                <div>
                  <label for="customItemQty">Does this item have a quantity?</label>
                  <select id="customItemQty">
                    <option value="false">No - Single item only</option>
                    <option value="true">Yes - Track quantity</option>
                  </select>
                </div>
                <div class="setup-form-actions">
                  <button class="btn-submit" id="addCustomItemBtn">Add to Checklist</button>
                  <button class="btn-cancel" id="cancelCustomItemBtn" style="border: 2px solid #dc2626; color: #dc2626;">Cancel</button>
                </div>
              </div>
            </div>

            ${setupSections}

            <div class="setup-save">
              <button class="btn-submit" id="saveRoomTemplateBtn">âœ“ Save Room Setup</button>
            </div>
          </div>
        `;

        const saveRoomTemplateBtn = document.getElementById('saveRoomTemplateBtn');
        saveRoomTemplateBtn.addEventListener('click', async () => {
          const selectedInputs = roomDetailContainer.querySelectorAll('input[type="checkbox"]:checked');
          if (!selectedInputs.length) {
            showToast('Select at least one item', 'error');
            return;
          }
          saveRoomTemplateBtn.disabled = true;
          saveRoomTemplateBtn.textContent = 'Saving...';
          for (const checkbox of selectedInputs) {
            const itemName = checkbox.getAttribute('data-item');
            const category = checkbox.getAttribute('data-category');
            const qtyInput = roomDetailContainer.querySelector(`input[data-qty-for="${checkbox.id}"]`);
            const quantity = qtyInput ? parseInt(qtyInput.value || '1', 10) : 1;
            const payload = {
              id: `${roomNumber}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
              room_type: 'room_item',
              room_number: roomNumber,
              category,
              item_name: itemName,
              quantity: Number.isNaN(quantity) ? 1 : quantity,
              status: 'good',
              notes: '',
              last_checked: new Date().toISOString(),
              added_timestamp: new Date().toISOString(),
              date_added: getLocalDateString(),
              is_archived: false
            };
            if (!roomItems.find(i => String(i.id) === String(payload.id))) {
              roomItems.push(payload);
            }
            await window.dataSdk.create(payload);
          }
          saveRoomTemplateBtn.disabled = false;
          saveRoomTemplateBtn.textContent = 'âœ“ Save Room Setup';
          showToast(`Room ${roomNumber} setup saved`, 'success');
          renderRoomDetail(roomNumber);
        });

        const showCustomItemFormBtn = document.getElementById('showCustomItemFormBtn');
        const customItemForm = document.getElementById('customItemForm');
        const addCustomItemBtn = document.getElementById('addCustomItemBtn');
        const cancelCustomItemBtn = document.getElementById('cancelCustomItemBtn');
        const customItemName = document.getElementById('customItemName');
        const customItemQty = document.getElementById('customItemQty');

        if (showCustomItemFormBtn && customItemForm) {
          showCustomItemFormBtn.addEventListener('click', () => {
            customItemForm.classList.remove('hidden');
            customItemName && customItemName.focus();
          });
        }

        if (cancelCustomItemBtn && customItemForm) {
          cancelCustomItemBtn.addEventListener('click', () => {
            customItemForm.classList.add('hidden');
          });
        }

        if (addCustomItemBtn) {
          addCustomItemBtn.addEventListener('click', (event) => {
            event.preventDefault();
            const nameValue = customItemName.value.trim();
            if (!nameValue) {
              showToast('Enter a custom item name', 'error');
              return;
            }
            const qtyValue = customItemQty.value === 'true';
            if (!roomSetupCustomItems[roomNumber]) roomSetupCustomItems[roomNumber] = [];
            roomSetupCustomItems[roomNumber].push({ name: nameValue, qty: qtyValue });
            customItemName.value = '';
            customItemQty.value = 'false';
            customItemForm.classList.add('hidden');
            renderRoomDetail(roomNumber);
          });
        }
      } else {
        const grouped = {};
        items.forEach(item => {
          if (!grouped[item.category]) grouped[item.category] = [];
          grouped[item.category].push(item);
        });

        const sections = Object.keys(grouped).sort().map(category => {
          const itemRows = grouped[category].map(item => {
            const statusLabel = item.status === 'broken' ? 'Broken' : item.status === 'missing' ? 'Missing' : 'Good';
            return `
              <div class="room-item">
                <div>
                  <div class="room-item-name">${item.item_name}</div>
                  <div class="room-item-meta">Qty: ${item.quantity || 1} â€¢ Status: ${statusLabel}</div>
                  ${item.notes ? `<div class="room-item-meta">Notes: ${item.notes}</div>` : ''}
                </div>
                <div class="room-item-actions">
                  <button class="room-action-btn" data-action="edit" data-id="${item.id}">âœï¸ Edit</button>
                  <button class="room-action-btn warn" data-action="issue" data-id="${item.id}">ğŸ”§ Report Issue</button>
                  <button class="room-action-btn danger" data-action="delete" data-id="${item.id}">âŒ Delete</button>
                </div>
              </div>
            `;
          }).join('');

          return `
            <div class="room-section">
              <div class="room-section-title">${category}</div>
              ${itemRows}
            </div>
          `;
        }).join('');

        roomDetailContainer.innerHTML = `${header}${sections}`;

        roomDetailContainer.querySelectorAll('[data-action="edit"]').forEach(btn => {
          btn.addEventListener('click', () => openRoomEditModal(btn.getAttribute('data-id')));
        });
        roomDetailContainer.querySelectorAll('[data-action="issue"]').forEach(btn => {
          btn.addEventListener('click', () => openRoomIssueModal(btn.getAttribute('data-id')));
        });
        roomDetailContainer.querySelectorAll('[data-action="delete"]').forEach(btn => {
          btn.addEventListener('click', () => openRoomDeleteModal(btn.getAttribute('data-id')));
        });
      }

      const backBtn = document.getElementById('backToRoomsBtn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          currentRoomNumber = null;
          renderRoomRegistry();
        });
      }

      const checkBtn = document.getElementById('checkRoomBtn');
      if (checkBtn) {
        checkBtn.addEventListener('click', async () => {
          const roomData = getRoomItems(roomNumber);
          for (const item of roomData) {
            const updatedItem = { ...item, last_checked: new Date().toISOString() };
            await window.dataSdk.update(updatedItem);
            const idx = roomItems.findIndex(i => String(i.id) === String(updatedItem.id));
            if (idx >= 0) roomItems[idx] = updatedItem;
          }
          showToast(`Room ${roomNumber} checked`, 'success');
        });
      }

      const addCustomBtn = document.getElementById('addCustomRoomItemBtn');
      if (addCustomBtn) {
        addCustomBtn.addEventListener('click', () => openRoomAddModal(roomNumber));
      }
    }

    function updateMaintenanceCount() {
      if (!maintenanceCount) return;
      const issues = getRoomIssues(roomItems);
      maintenanceCount.textContent = issues.length;
    }

    function renderMaintenanceQueue() {
      if (!maintenanceList) {
        updateMaintenanceCount();
        return;
      }
      const issues = getRoomIssues(roomItems);
      updateMaintenanceCount();
      if (currentPage !== 'room-maintenance') return;
      if (issues.length === 0) {
        maintenanceList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âœ…</div>
            <div class="empty-title">No active issues</div>
            <div class="empty-subtitle">All rooms are in good condition.</div>
          </div>
        `;
        return;
      }
      maintenanceList.innerHTML = issues.map(issue => {
        return `
          <div class="maintenance-card">
            <div class="maintenance-title">Room ${issue.room_number} â€¢ ${issue.item_name}</div>
            <div class="room-item-meta">Issue: ${issue.status === 'broken' ? 'Broken' : 'Missing'}${issue.notes ? ` â€¢ ${issue.notes}` : ''}</div>
            <button class="room-action-btn" data-resolve="${issue.id}">âœ… Mark Resolved</button>
          </div>
        `;
      }).join('');

      maintenanceList.querySelectorAll('[data-resolve]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-resolve');
          const item = roomItems.find(i => String(i.id) === String(id));
          if (!item) return;
          const updatedItem = { ...item, status: 'good', notes: '' };
          await window.dataSdk.update(updatedItem);
          const idx = roomItems.findIndex(i => String(i.id) === String(updatedItem.id));
          if (idx >= 0) roomItems[idx] = updatedItem;
          showToast('Issue resolved', 'success');
          renderMaintenanceQueue();
          renderRoomRegistry();
        });
      });
    }

    function openRoomModal(title, bodyHtml, confirmText, onConfirm) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">${title}</div>
          <div class="modal-text">${bodyHtml}</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" id="roomModalConfirm">${confirmText}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const confirmBtn = document.getElementById('roomModalConfirm');
      confirmBtn.addEventListener('click', onConfirm);
    }

    function openRoomEditModal(itemId) {
      const item = roomItems.find(i => String(i.id) === String(itemId));
      if (!item) return;
      openRoomModal(
        'Edit Item',
        `
          <div class="form-row">
            <div class="form-group"><label class="form-label">Item Name</label><input class="form-input" id="roomEditName" value="${item.item_name}"></div>
            <div class="form-group"><label class="form-label">Quantity</label><input class="form-input" id="roomEditQty" type="number" min="1" value="${item.quantity || 1}"></div>
          </div>
        `,
        'Save',
        async () => {
          const name = document.getElementById('roomEditName').value.trim();
          const qty = parseInt(document.getElementById('roomEditQty').value, 10) || 1;
          const updatedItem = { ...item, item_name: name || item.item_name, quantity: qty };
          await window.dataSdk.update(updatedItem);
          const idx = roomItems.findIndex(i => String(i.id) === String(updatedItem.id));
          if (idx >= 0) roomItems[idx] = updatedItem;
          closeModal();
          showToast('Item updated', 'success');
          if (currentRoomNumber) renderRoomDetail(currentRoomNumber);
        }
      );
    }

    function openRoomIssueModal(itemId) {
      const item = roomItems.find(i => String(i.id) === String(itemId));
      if (!item) return;
      openRoomModal(
        'Report Issue',
        `
          <div class="form-row">
            <div class="form-group"><label class="form-label">Issue Type</label>
              <select class="form-select" id="roomIssueType">
                <option value="broken">Broken</option>
                <option value="missing">Missing</option>
              </select>
            </div>
            <div class="form-group"><label class="form-label">Notes (Optional)</label><input class="form-input" id="roomIssueNotes" placeholder="Add notes"></div>
          </div>
        `,
        'Report',
        async () => {
          const issueType = document.getElementById('roomIssueType').value;
          const notes = document.getElementById('roomIssueNotes').value.trim();
          const updatedItem = { ...item, status: issueType, notes };
          await window.dataSdk.update(updatedItem);
          const idx = roomItems.findIndex(i => String(i.id) === String(updatedItem.id));
          if (idx >= 0) roomItems[idx] = updatedItem;
          closeModal();
          showToast('Issue reported', 'success');
          if (currentRoomNumber) renderRoomDetail(currentRoomNumber);
          renderMaintenanceQueue();
          renderRoomRegistry();
        }
      );
    }

    function openRoomDeleteModal(itemId) {
      const item = roomItems.find(i => String(i.id) === String(itemId));
      if (!item) return;
      openRoomModal(
        'Delete Item',
        `Are you sure you want to delete ${item.item_name} from Room ${item.room_number}?`,
        'Delete',
        async () => {
          await window.dataSdk.delete(item);
          roomItems = roomItems.filter(i => String(i.id) !== String(item.id));
          closeModal();
          showToast('Item deleted', 'success');
          if (currentRoomNumber) renderRoomDetail(currentRoomNumber);
          renderMaintenanceQueue();
          renderRoomRegistry();
        }
      );
    }

    function openRoomAddModal(roomNumber) {
      openRoomModal(
        'Add Custom Item',
        `
          <div class="form-row">
            <div class="form-group"><label class="form-label">Category</label><input class="form-input" id="roomAddCategory" placeholder="Category"></div>
            <div class="form-group"><label class="form-label">Item Name</label><input class="form-input" id="roomAddName" placeholder="Item name"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Quantity</label><input class="form-input" id="roomAddQty" type="number" min="1" value="1"></div>
          </div>
        `,
        'Add',
        async () => {
          const category = document.getElementById('roomAddCategory').value.trim() || 'Custom';
          const name = document.getElementById('roomAddName').value.trim();
          const qty = parseInt(document.getElementById('roomAddQty').value, 10) || 1;
          if (!name) {
            showToast('Enter item name', 'error');
            return;
          }
          const payload = {
            id: `${roomNumber}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
            room_type: 'room_item',
            room_number: roomNumber,
            category,
            item_name: name,
            quantity: qty,
            status: 'good',
            notes: '',
            last_checked: new Date().toISOString(),
            added_timestamp: new Date().toISOString(),
            date_added: getLocalDateString(),
            is_archived: false
          };
          await window.dataSdk.create(payload);
          if (!roomItems.find(i => String(i.id) === String(payload.id))) {
            roomItems.push(payload);
          }
          closeModal();
          showToast('Item added', 'success');
          if (currentRoomNumber) renderRoomDetail(currentRoomNumber);
          renderRoomRegistry();
        }
      );
    }

    if (maintenanceQueueBtn) {
      maintenanceQueueBtn.addEventListener('click', () => navigateTo('room-maintenance'));
    }

    // ============== STOCK LOCATIONS FUNCTIONALITY ==============

    const stockLocationsContainer = document.getElementById('stockLocationsContainer');
    const stockDetailContainer = document.getElementById('stockDetailContainer');
    const stockDetailTitle = document.getElementById('stockDetailTitle');
    const stockDetailMeta = document.getElementById('stockDetailMeta');
    const stockCheckedBtn = document.getElementById('stockCheckedBtn');
    const addStockItemBtn = document.getElementById('addStockItemBtn');
    const backToStockLocationsBtn = document.getElementById('backToStockLocationsBtn');

    const stockLocationSections = [
      {
        title: 'Floor 1 Storage (F1-01 to F1-13)',
        locations: Array.from({ length: 13 }, (_, i) => `Storage F1-${String(i + 1).padStart(2, '0')}`)
      },
      {
        title: 'Floor 2 Storage (F2-01 to F2-11)',
        locations: Array.from({ length: 11 }, (_, i) => `Storage F2-${String(i + 1).padStart(2, '0')}`)
      },
      {
        title: 'Floor 3 Storage (F3-01 to F3-12)',
        locations: Array.from({ length: 12 }, (_, i) => `Storage F3-${String(i + 1).padStart(2, '0')}`)
      },
      {
        title: 'Other Locations',
        locations: ['Garage', 'Luggage Room']
      }
    ];

    function formatStockDate(value) {
      if (!value) return 'Never';
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return String(value);
      return parsed.toLocaleDateString();
    }

    function getStockItemsForLocation(locationName) {
      return stockLocationItems.filter(item => (item.location_name || item.location) === locationName);
    }

    function getLatestChecked(items) {
      if (!items.length) return 'Never';
      const latest = items.reduce((acc, item) => {
        if (!item.last_checked) return acc;
        if (!acc) return item.last_checked;
        return new Date(item.last_checked) > new Date(acc) ? item.last_checked : acc;
      }, null);
      return formatStockDate(latest);
    }

    function renderStockLocations() {
      if (!stockLocationsContainer) return;
      if (currentPage !== 'stock-locations') return;

      stockLocationsContainer.innerHTML = stockLocationSections.map(section => {
        const cards = section.locations.map(locationName => {
          const items = getStockItemsForLocation(locationName);
          const lastChecked = getLatestChecked(items);
          const firstItem = items[0];
          const preview = firstItem
            ? `${firstItem.item_name}`
            : 'Empty';
          const icon = items.length ? 'ğŸ“¦' : 'âšª';
          const shortLabel = locationName.replace(/^Storage\s+/i, '');
          return `
            <div class="storage-card storage-card-v2 ${items.length ? 'has-items' : ''}" data-stock-location="${locationName}">
              <div class="storage-icon">${icon}</div>
              <div class="storage-id">${shortLabel}</div>
              <div class="storage-preview prominent">${preview}</div>
            </div>
          `;
        }).join('');

        return `
          <div class="room-section" style="margin-bottom: 2rem;">
            <div class="room-section-title playfair" style="font-size: 1.5rem; color: #d4af37; margin-bottom: 1rem;">${section.title}</div>
            <div class="storage-grid">${cards}</div>
          </div>
        `;
      }).join('');

      stockLocationsContainer.querySelectorAll('[data-stock-location]').forEach(card => {
        card.addEventListener('click', () => {
          const locationName = card.getAttribute('data-stock-location');
          currentStockLocation = locationName;
          navigateTo('stock-detail');
        });
      });
    }

    function renderStockDetail() {
      if (!stockDetailContainer || !stockDetailTitle || !stockDetailMeta) return;
      if (currentPage !== 'stock-detail') return;
      if (!currentStockLocation) return;

      const items = getStockItemsForLocation(currentStockLocation);
      stockDetailTitle.textContent = currentStockLocation;
      stockDetailMeta.textContent = `Items: ${items.length} â€¢ Last checked: ${getLatestChecked(items)}`;

      if (!items.length) {
        stockDetailContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“¦</div>
            <div class="empty-title">No items in this location</div>
            <div class="empty-subtitle">Add the first item to get started.</div>
          </div>
        `;
      } else {
        stockDetailContainer.innerHTML = items.map(item => {
          return `
            <div class="equipment-card">
              <div class="equipment-header">
                <div>
                  <div class="equipment-name">${item.item_name}</div>
                  <div class="room-item-meta">Qty: ${item.quantity || 0}${item.unit ? ` ${item.unit}` : ''}</div>
                  ${item.notes ? `<div class="room-item-meta">Notes: ${item.notes}</div>` : ''}
                </div>
              </div>
              <div class="room-item-actions">
                <button class="room-action-btn" data-stock-edit="${item.id}">âœï¸ Edit</button>
                <button class="room-action-btn danger" data-stock-delete="${item.id}">ğŸ—‘ï¸ Delete</button>
              </div>
            </div>
          `;
        }).join('');

        stockDetailContainer.querySelectorAll('[data-stock-edit]').forEach(btn => {
          btn.addEventListener('click', () => {
            const itemId = btn.getAttribute('data-stock-edit');
            const item = stockLocationItems.find(i => String(i.id) === String(itemId));
            if (item) openStockItemModal(item);
          });
        });

        stockDetailContainer.querySelectorAll('[data-stock-delete]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const itemId = btn.getAttribute('data-stock-delete');
            const item = stockLocationItems.find(i => String(i.id) === String(itemId));
            if (!item) return;
            await window.dataSdk.delete(item);
            stockLocationItems = stockLocationItems.filter(i => String(i.id) !== String(itemId));
            renderStockDetail();
            renderStockLocations();
            showToast('Item deleted', 'success');
          });
        });
      }

      if (addStockItemBtn) {
        addStockItemBtn.onclick = () => openStockItemModal();
      }

      if (backToStockLocationsBtn) {
        backToStockLocationsBtn.onclick = () => navigateTo('stock-locations');
      }

      if (stockCheckedBtn) {
        stockCheckedBtn.onclick = async () => {
          const itemsToUpdate = getStockItemsForLocation(currentStockLocation);
          const now = new Date().toISOString();
          for (const item of itemsToUpdate) {
            const updatedItem = { ...item, last_checked: now };
            await window.dataSdk.update(updatedItem);
            const idx = stockLocationItems.findIndex(i => String(i.id) === String(updatedItem.id));
            if (idx >= 0) stockLocationItems[idx] = updatedItem;
          }
          renderStockDetail();
          renderStockLocations();
          showToast('Stock location checked', 'success');
        };
      }
    }

    function openStockItemModal(item = null) {
      if (!currentStockLocation) return;
      const isEdit = Boolean(item);
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">${isEdit ? 'Edit Item' : 'Add Item'} â€¢ ${currentStockLocation}</div>
          <div class="modal-text">
            <div class="form-row">
              <div class="form-group"><label class="form-label">Item Name *</label><input class="form-input" id="stockItemName" value="${item ? item.item_name : ''}"></div>
              <div class="form-group"><label class="form-label">Quantity *</label><input class="form-input" id="stockItemQty" type="number" min="0" value="${item ? item.quantity : ''}"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label class="form-label">Unit (Optional)</label><input class="form-input" id="stockItemUnit" value="${item ? (item.unit || '') : ''}"></div>
              <div class="form-group"><label class="form-label">Notes (Optional)</label><input class="form-input" id="stockItemNotes" value="${item ? (item.notes || '') : ''}"></div>
            </div>
          </div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" id="stockModalConfirm">${isEdit ? 'Save' : 'Add'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      const confirmBtn = document.getElementById('stockModalConfirm');
      confirmBtn.addEventListener('click', async () => {
        const name = document.getElementById('stockItemName').value.trim();
        const qty = parseInt(document.getElementById('stockItemQty').value, 10);
        const unit = document.getElementById('stockItemUnit').value.trim();
        const notes = document.getElementById('stockItemNotes').value.trim();

        if (!name || Number.isNaN(qty)) {
          showToast('Please enter item name and quantity', 'error');
          return;
        }

        if (isEdit) {
          const updatedItem = { ...item, item_name: name, quantity: qty, unit: unit || null, notes: notes || null };
          await window.dataSdk.update(updatedItem);
          const idx = stockLocationItems.findIndex(i => String(i.id) === String(updatedItem.id));
          if (idx >= 0) stockLocationItems[idx] = updatedItem;
          closeModal();
          renderStockDetail();
          renderStockLocations();
          showToast('Item updated', 'success');
          return;
        }

        const floorMatch = currentStockLocation.match(/F(\d)/i);
        const payload = {
          id: `${currentStockLocation}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          stock_type: 'stock_location',
          location_name: currentStockLocation,
          location: currentStockLocation,
          floor: floorMatch ? `F${floorMatch[1]}` : null,
          item_name: name,
          quantity: qty,
          unit: unit || null,
          notes: notes || null,
          last_checked: new Date().toISOString(),
          added_timestamp: new Date().toISOString(),
          date_added: getLocalDateString(),
          is_archived: false
        };
        await window.dataSdk.create(payload);
        if (!stockLocationItems.find(i => String(i.id) === String(payload.id))) {
          stockLocationItems.push(payload);
        }
        closeModal();
        renderStockDetail();
        renderStockLocations();
        showToast('Item added', 'success');
      });
    }

    // ============== REST OF THE CODE (EXPIRATION, NOTIFICATIONS, ARCHIVE) ==============

    // Expiration Control functionality
    const addItemBtn = document.getElementById('addItemBtn');
    const formContainer = document.getElementById('formContainer');
    const expirationForm = document.getElementById('expirationForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const submitBtn = document.getElementById('submitBtn');

    addItemBtn.addEventListener('click', function() {
      formContainer.classList.toggle('hidden');
    });

    cancelBtn.addEventListener('click', function() {
      formContainer.classList.add('hidden');
      expirationForm.reset();
    });

    expirationForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const itemName = document.getElementById('itemName').value;
      const expirationDate = document.getElementById('expirationDate').value;
      const location = document.getElementById('location').value;
      const quantity = document.getElementById('quantity').value;

      if (!itemName || !expirationDate || !location) {
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Adding...';

      const today = getLocalDateString();
      
      // Check if we need to auto-archive - compare dates of existing items
      const hasOldItems = allItems.some(item => item.date_added !== today);
      if (hasOldItems) {
        // Auto-archive all items from previous days
        for (const item of allItems) {
          if (item.date_added !== today) {
            const archiveResult = await window.dataSdk.update({
              ...item,
              is_archived: true
            });
            if (!archiveResult.isOk) {
              console.error("Failed to archive item:", archiveResult.error);
            }
          }
        }
      }

      const newItem = {
        id: Date.now().toString(),
        item_name: itemName,
        category: getCategoryFromItem(itemName),
        expiration_date: expirationDate,
        location: location,
        quantity: quantity ? parseInt(quantity) : null,
        added_timestamp: new Date().toISOString(),
        date_added: today,
        is_archived: false
      };

      const result = await window.dataSdk.create(newItem);
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Item';

      if (result.isOk) {
        expirationForm.reset();
        formContainer.classList.add('hidden');
        showToast('Item added successfully', 'success');
      } else {
        showToast('Failed to add item. Please try again.', 'error');
      }
    });

    function getCategoryFromItem(itemName) {
      const snacks = ['Fudge', 'Cheese Nibbles', 'Chips', 'Almonds', 'Chocolate Peanuts'];
      const softDrinks = ['Sparkling Water', 'Coca-Cola', 'Coca-Cola Zero', 'Tonic', 'Apple Juice', 'Ginger Ale', 'Lemonade'];
      
      if (snacks.includes(itemName)) return 'snacks';
      if (softDrinks.includes(itemName)) return 'soft_drinks';
      return 'alcohol';
    }

    function updateCurrentDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
    }

    function updateExpirationDisplay() {
      const itemCount = document.getElementById('itemCount');
      const totalQuantity = document.getElementById('totalQuantity');
      const itemsContainer = document.getElementById('itemsContainer');

      itemCount.textContent = allItems.length;
      
      const total = allItems.reduce((sum, item) => sum + (item.quantity || 0), 0);
      totalQuantity.textContent = total || '0';

      if (allItems.length === 0) {
        itemsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âœ…</div>
            <div class="empty-title">No expired items today</div>
            <div class="empty-subtitle">Add items as you find them during your checks</div>
          </div>
        `;
      } else {
        // Group items by date
        const groupedByDate = {};
        allItems.forEach(item => {
          const date = item.date_added;
          if (!groupedByDate[date]) {
            groupedByDate[date] = [];
          }
          groupedByDate[date].push(item);
        });

        // Sort dates (most recent first)
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

        itemsContainer.innerHTML = sortedDates.map(date => {
          const items = groupedByDate[date];
          const formattedDate = new Date(date).toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });
          const totalQty = items.reduce((sum, item) => sum + (item.quantity || 0), 0);

          return `
            <div class="date-group" data-date="${date}">
              <div class="date-banner" onclick="toggleExpirationDateGroup('${date}')">
                <div class="date-banner-left">
                  <span class="expand-arrow" id="arrow-expiration-${date}">â–¶</span>
                  <span class="date-title">${formattedDate}</span>
                  <span class="item-count-badge">${items.length} items</span>
                  <span class="item-count-badge">Total Qty: ${totalQty}</span>
                </div>
                <div class="date-banner-actions">
                  <button class="btn-save-pdf" onclick="event.stopPropagation(); saveActiveExpirationPDF('${date}')">ğŸ“¥ Save PDF</button>
                  <button class="btn-archive" onclick="event.stopPropagation(); confirmArchiveExpirationGroup('${date}', ${items.length})">ğŸ“ Archive All</button>
                  <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteExpirationGroup('${date}', ${items.length})">ğŸ—‘ï¸ Delete All</button>
                </div>
              </div>
              <div class="notifications-list" id="list-expiration-${date}">
                ${items.map(item => createItemCard(item)).join('')}
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners for action buttons
        allItems.forEach(item => {
          const archiveBtn = document.getElementById(`archive-${item.id}`);
          const deleteBtn = document.getElementById(`delete-${item.id}`);

          if (archiveBtn) {
            archiveBtn.addEventListener('click', () => archiveItem(item));
          }
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => deleteItem(item));
          }
        });
      }
    }

    function createItemCard(item) {
      const icon = categoryIcons[item.item_name] || 'ğŸ“¦';
      const expDate = new Date(item.expiration_date).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric' 
      });
      const addedDate = new Date(item.added_timestamp).toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      const quantityText = item.quantity ? `${item.quantity} units` : 'N/A';

      return `
        <div class="item-card">
          <div class="item-main">
            <div class="item-icon">${icon}</div>
            <div class="item-content">
              <div class="item-name">${item.item_name}</div>
              <div class="item-details">
                <div class="item-detail"><strong>Expired On:</strong> ${expDate}</div>
                <div class="item-detail"><strong>Location:</strong> ${item.location}</div>
                <div class="item-detail"><strong>Quantity:</strong> ${quantityText}</div>
                <div class="item-detail"><strong>Added to System:</strong> ${addedDate}</div>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="btn-archive" id="archive-${item.id}">ğŸ“ Archive Now</button>
            <button class="btn-delete" id="delete-${item.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    async function archiveItem(item) {
      const btn = document.getElementById(`archive-${item.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Archiving...';

      const result = await window.dataSdk.update({
        ...item,
        is_archived: true
      });

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“ Archive Now';
        console.error("Failed to archive item:", result.error);
      }
    }

    async function deleteItem(item) {
      const btn = document.getElementById(`delete-${item.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(item);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = '    ï¸ Delete';
        console.error("Failed to delete item:", result.error);
      }
    }

    // ============== NOTIFICATION CENTER FUNCTIONALITY ==============

    const addNotificationBtn = document.getElementById('addNotificationBtn');
    const notificationFormContainer = document.getElementById('notificationFormContainer');
    const notificationForm = document.getElementById('notificationForm');
    const cancelNotificationBtn = document.getElementById('cancelNotificationBtn');
    const submitNotificationBtn = document.getElementById('submitNotificationBtn');
    const orderSummaryContainer = document.getElementById('orderSummaryContainer');
    const orderSummaryList = document.getElementById('orderSummaryList');
    const orderSummaryEmpty = document.getElementById('orderSummaryEmpty');
    const toggleOrderSummaryBtn = document.getElementById('toggleOrderSummaryBtn');
    const clearOrderSummaryBtn = document.getElementById('clearOrderSummaryBtn');
    const rebuildOrderSummaryBtn = document.getElementById('rebuildOrderSummaryBtn');
    const printOrderSummaryBtn = document.getElementById('printOrderSummaryBtn');
    const notificationTypeSelect = document.getElementById('notificationType');
    const dynamicFormFields = document.getElementById('dynamicFormFields');

    const notificationIcons = {
      'low_stock': 'ğŸ“‰',
      'damaged': 'âš ï¸',
      'broken': 'ğŸ”§',
      'stolen': '   ',
      'missing': 'â“',
      'other': 'ğŸ“'
    };

    const notificationLabels = {
      'low_stock': 'Low Stock',
      'damaged': 'Damaged Item',
      'broken': 'Broken Equipment',
      'stolen': 'Stolen/Missing',
      'missing': 'Item Missing',
      'other': 'Other Issue'
    };

    if (addNotificationBtn) {
      addNotificationBtn.addEventListener('click', function() {
        notificationFormContainer.classList.toggle('hidden');
      });
    }

    function getOrderSummaryItems() {
      const summary = new Map();
      allNotifications
        .filter(notif => notif.type === 'low_stock')
        .forEach(notif => {
          const key = notif.item_name || 'Unknown Item';
          const current = summary.get(key) || 0;
          summary.set(key, current + (notif.order_quantity || 0));
        });
      return Array.from(summary.entries())
        .map(([item, qty]) => ({ item, qty }))
        .sort((a, b) => b.qty - a.qty);
    }

    function renderOrderSummary() {
      if (!orderSummaryContainer || !orderSummaryList || !orderSummaryEmpty) return;
      const isCleared = localStorage.getItem('orderSummaryCleared') === '1';
      const isCollapsed = localStorage.getItem('orderSummaryCollapsed') === '1';
      if (toggleOrderSummaryBtn) {
        toggleOrderSummaryBtn.textContent = isCollapsed ? 'Expand' : 'Collapse';
      }
      orderSummaryContainer.classList.toggle('collapsed', isCollapsed);
      if (rebuildOrderSummaryBtn) {
        rebuildOrderSummaryBtn.style.display = isCleared ? 'inline-block' : 'none';
      }
      if (isCleared) {
        orderSummaryList.innerHTML = '';
        orderSummaryEmpty.textContent = 'Summary cleared.';
        return;
      }

      const items = getOrderSummaryItems();
      if (items.length === 0) {
        orderSummaryList.innerHTML = '';
        orderSummaryEmpty.textContent = 'No low stock orders right now.';
        return;
      }

      orderSummaryEmpty.textContent = '';
      orderSummaryList.innerHTML = items
        .map(item => `<div class="order-summary-item"><span>${item.item}</span><span class="order-summary-qty">${item.qty}</span></div>`)
        .join('');
    }

    if (toggleOrderSummaryBtn) {
      toggleOrderSummaryBtn.addEventListener('click', function() {
        const isCollapsed = localStorage.getItem('orderSummaryCollapsed') === '1';
        localStorage.setItem('orderSummaryCollapsed', isCollapsed ? '0' : '1');
        renderOrderSummary();
      });
    }

    if (clearOrderSummaryBtn) {
      clearOrderSummaryBtn.addEventListener('click', function() {
        localStorage.setItem('orderSummaryCleared', '1');
        renderOrderSummary();
      });
    }

    if (rebuildOrderSummaryBtn) {
      rebuildOrderSummaryBtn.addEventListener('click', function() {
        localStorage.setItem('orderSummaryCleared', '0');
        renderOrderSummary();
      });
    }

    if (printOrderSummaryBtn) {
      printOrderSummaryBtn.addEventListener('click', function() {
        const items = getOrderSummaryItems();
        if (items.length === 0) {
          showToast('No items to print', 'error');
          return;
        }

        const formattedDate = new Date().toLocaleDateString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric'
        });

        const htmlContent = `
          <html>
          <head>
            <title>Order Summary - ${formattedDate}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; }
              h1 { color: #0d1b2a; border-bottom: 3px solid #d4af37; padding-bottom: 10px; }
              .item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
              .qty { font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Order Summary - ${formattedDate}</h1>
            ${items.map(item => `<div class="item"><span>${item.item}</span><span class="qty">${item.qty}</span></div>`).join('')}
          </body>
          </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.print();
      });
    }

    cancelNotificationBtn.addEventListener('click', function() {
      notificationFormContainer.classList.add('hidden');
      notificationForm.reset();
      dynamicFormFields.innerHTML = '';
    });

    notificationTypeSelect.addEventListener('change', function() {
      const type = this.value;
      dynamicFormFields.innerHTML = '';

      if (type === 'low_stock') {
        dynamicFormFields.innerHTML = `
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="notifItemName">Item Name *</label>
              <input type="text" class="form-input" id="notifItemName" placeholder="e.g., Red Wine" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="stockF1">F1 Stock *</label>
              <input type="number" class="form-input stock-input" id="stockF1" placeholder="0" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="stockF2">F2 Stock *</label>
              <input type="number" class="form-input stock-input" id="stockF2" placeholder="0" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="stockF3">F3 Stock *</label>
              <input type="number" class="form-input stock-input" id="stockF3" placeholder="0" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="stockOffice">Office Stock *</label>
              <input type="number" class="form-input stock-input" id="stockOffice" placeholder="0" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Total Current Stock</label>
              <input type="text" class="form-input" id="totalStock" readonly style="background: rgba(212, 175, 55, 0.1); cursor: not-allowed;" value="0">
            </div>
            <div class="form-group">
              <label class="form-label">Recommended Order Quantity</label>
              <input type="text" class="form-input" id="orderQuantity" readonly style="background: rgba(212, 175, 55, 0.1); cursor: not-allowed;" value="0">
            </div>
          </div>
        `;

        // Add auto-calculation
        const stockInputs = document.querySelectorAll('.stock-input');
        stockInputs.forEach(input => {
          input.addEventListener('input', calculateStockTotals);
        });
      } else {
        dynamicFormFields.innerHTML = `
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="notifItemName">Item Name *</label>
              <input type="text" class="form-input" id="notifItemName" placeholder="e.g., Vacuum Cleaner" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="notifSource">Source *</label>
              <select class="form-select" id="notifSource" required>
                <option value="">Select source...</option>
                <option value="Minibar Stock">Minibar Stock</option>
                <option value="Housekeeping Equipment" selected>Housekeeping Equipment</option>
                <option value="Public Area">Public Area</option>
                <option value="Room Registry">Room Registry</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="notifLocation">Location *</label>
              <input type="text" class="form-input" id="notifLocation" placeholder="e.g., Floor 2, Room 305, Lobby" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="notifDescription">Description *</label>
              <textarea class="form-input" id="notifDescription" placeholder="Describe the issue..." rows="3" required style="resize: vertical;"></textarea>
            </div>
          </div>
        `;
      }
    });

    function calculateStockTotals() {
      const f1 = parseInt(document.getElementById('stockF1')?.value) || 0;
      const f2 = parseInt(document.getElementById('stockF2')?.value) || 0;
      const f3 = parseInt(document.getElementById('stockF3')?.value) || 0;
      const office = parseInt(document.getElementById('stockOffice')?.value) || 0;
      
      const total = f1 + f2 + f3 + office;
      const orderQty = Math.max(0, 40 - total);

      document.getElementById('totalStock').value = total;
      document.getElementById('orderQuantity').value = orderQty;
    }

    notificationForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const type = notificationTypeSelect.value;
      if (!type) return;

      submitNotificationBtn.disabled = true;
      submitNotificationBtn.innerHTML = '<span class="loading-spinner"></span>Adding...';

      const today = getLocalDateString();
      const itemName = document.getElementById('notifItemName').value;

      let newNotification = {
        id: Date.now().toString(),
        type: type,
        item_name: itemName,
        added_timestamp: new Date().toISOString(),
        date_added: today,
        is_archived: false
      };

      if (type === 'low_stock') {
        const f1 = parseInt(document.getElementById('stockF1').value) || 0;
        const f2 = parseInt(document.getElementById('stockF2').value) || 0;
        const f3 = parseInt(document.getElementById('stockF3').value) || 0;
        const office = parseInt(document.getElementById('stockOffice').value) || 0;
        const total = f1 + f2 + f3 + office;
        const orderQty = Math.max(0, 40 - total);

        newNotification.source = 'Minibar Stock';
        newNotification.stock_f1 = f1;
        newNotification.stock_f2 = f2;
        newNotification.stock_f3 = f3;
        newNotification.stock_office = office;
        newNotification.total_stock = total;
        newNotification.order_quantity = orderQty;
      } else {
        newNotification.source = document.getElementById('notifSource').value;
        newNotification.location = document.getElementById('notifLocation').value;
        newNotification.description = document.getElementById('notifDescription').value;
      }

      const result = await window.dataSdk.create(newNotification);

      submitNotificationBtn.disabled = false;
      submitNotificationBtn.textContent = 'Add Notification';

      if (result.isOk) {
        notificationForm.reset();
        dynamicFormFields.innerHTML = '';
        notificationFormContainer.classList.add('hidden');
      } else {
        showToast('Failed to add notification. Please try again.', 'error');
      }
    });

    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      const count = allNotifications.length;
      
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function updateNotificationsDisplay() {
      const container = document.getElementById('notificationsContainer');

      if (allNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-title">No notifications yet</div>
            <div class="empty-subtitle">Add a test notification to get started</div>
          </div>
        `;
        return;
      }

      // Group notifications by date
      const groupedByDate = {};
      allNotifications.forEach(notif => {
        const date = notif.date_added;
        if (!groupedByDate[date]) {
          groupedByDate[date] = [];
        }
        groupedByDate[date].push(notif);
      });

      // Sort dates (most recent first)
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      container.innerHTML = sortedDates.map(date => {      
        const notifications = groupedByDate[date];
        const issueTypes = ['broken', 'damaged', 'missing', 'stolen', 'other'];
        const issueNotifications = notifications.filter(notif => issueTypes.includes(notif.type));
        const otherNotifications = notifications.filter(notif => !issueTypes.includes(notif.type));
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        return `
          <div class="date-group" data-date="${date}">
            <div class="date-banner" onclick="toggleDateGroup('${date}')">
              <div class="date-banner-left">
                <span class="expand-arrow" id="arrow-${date}">â–¶</span>
                <span class="date-title">${formattedDate}</span>
                <span class="item-count-badge">${notifications.length} items</span>
              </div>
              <div class="date-banner-actions">
                <button class="btn-save-pdf" onclick="event.stopPropagation(); saveActiveNotificationsPDF('${date}')">ğŸ“¥ Save PDF</button>
                <button class="btn-archive" onclick="event.stopPropagation(); confirmArchiveNotificationsGroup('${date}', ${notifications.length})">ğŸ“ Archive All</button>
                <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteAll('${date}', ${notifications.length})">ğŸ—‘ï¸ Delete All</button>
              </div>
            </div>
            <div class="notifications-list" id="list-${date}">                                                              
              ${issueNotifications.length ? `<div class="notification-section-title">Reported Issues (${issueNotifications.length})</div>${issueNotifications.map(notif => createNotificationCard(notif)).join('')}` : ''}
              ${otherNotifications.length ? `<div class="notification-section-title">Other Notifications (${otherNotifications.length})</div>${otherNotifications.map(notif => createNotificationCard(notif)).join('')}` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners
      allNotifications.forEach(notif => {
        const deleteBtn = document.getElementById(`delete-notif-${notif.id}`);
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteNotification(notif));
        }

        if (notif.type !== 'low_stock') {
          const archiveBtn = document.getElementById(`archive-notif-${notif.id}`);
          if (archiveBtn) {
            archiveBtn.addEventListener('click', () => archiveNotification(notif));
          }
        }
      });

      renderOrderSummary();
    }

    function createNotificationCard(notif) {
      const icon = notificationIcons[notif.type] || 'ğŸ“';
      const label = notificationLabels[notif.type] || 'Notification';
      const addedDate = new Date(notif.added_timestamp).toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });

      let bodyContent = '';
      let actionButtons = '';

      if (notif.type === 'low_stock') {
        bodyContent = `
          <div class="notification-detail"><strong>Current Stock:</strong> ${notif.total_stock} units</div>
          <div class="notification-detail"><strong>Order Quantity:</strong> <span class="order-qty-badge">${notif.order_quantity} units</span> (to reach 40)</div>
          <div class="notification-detail"><strong>Breakdown:</strong> F1: ${notif.stock_f1} | F2: ${notif.stock_f2} | F3: ${notif.stock_f3} | Office: ${notif.stock_office}</div>
        `;
        actionButtons = `
          <div class="notification-actions">
            <button class="btn-delete-single" id="delete-notif-${notif.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        `;
      } else {
        bodyContent = `
          <div class="notification-detail"><strong>Location:</strong> ${notif.location}</div>
          <div class="notification-detail"><strong>Description:</strong> ${notif.description}</div>
        `;
        actionButtons = `
          <div class="notification-actions">
            <button class="btn-archive" id="archive-notif-${notif.id}">ğŸ“ Archive Now</button>
            <button class="btn-delete-single" id="delete-notif-${notif.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        `;
      }

      return `
        <div class="notification-card">
          <div class="notification-header">
            <span class="notification-icon">${icon}</span>
            <span class="notification-title">${label} - ${notif.item_name}</span>
          </div>
          <div class="notification-body">
            ${bodyContent}
          </div>
          ${actionButtons}
          <div class="notification-footer">
            <div><strong>Source:</strong> ${notif.source}</div>
            <div><strong>Added:</strong> ${addedDate}</div>
          </div>
        </div>
      `;
    }

    async function archiveNotification(notif) {
      const btn = document.getElementById(`archive-notif-${notif.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Archiving...';

      const result = await window.dataSdk.update({
        ...notif,
        is_archived: true
      });

      if (result.isOk) {
        showToast(`${notif.item_name} archived successfully`, 'success');
      } else {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“ Archive Now';
        showToast('Failed to archive notification', 'error');
      }
    }

    async function deleteNotification(notif) {
      const btn = document.getElementById(`delete-notif-${notif.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(notif);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete notification', 'error');
      }
    }

    function toggleDateGroup(date) {
      const arrow = document.getElementById(`arrow-${date}`);
      const list = document.getElementById(`list-${date}`);
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    }

    window.confirmDeleteStockGroup = function(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Confirm Delete All</div>
          <div class="modal-text">Delete all ${count} stock counts from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="deleteStockGroup('${date}')">Delete All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.deleteStockGroup = async function(date) {
      const itemsToDelete = allStockCounts.filter(sc => sc.date_added === date);
      for (const item of itemsToDelete) {
        await window.dataSdk.delete(item);
      }
      closeModal();
      showToast(`All stock counts from ${date} deleted`, 'success');
    };

    window.confirmArchiveStockGroup = function(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Archive All</div>
          <div class="modal-text">Archive all ${count} stock counts from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="archiveStockGroup('${date}')">Archive All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.archiveStockGroup = async function(date) {
      const itemsToArchive = allStockCounts.filter(sc => sc.date_added === date);
      for (const item of itemsToArchive) {
        await window.dataSdk.update({ ...item, is_archived: true });
      }
      closeModal();
      showToast(`All stock counts from ${date} archived`, 'success');
    };

    function confirmDeleteAll(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Confirm Delete All</div>
          <div class="modal-text">Are you sure you want to delete all ${count} notifications from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="deleteAllFromDate('${date}')">Delete All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    window.closeModal = function() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    };

    window.deleteAllFromDate = async function(date) {
      const notificationsToDelete = allNotifications.filter(n => n.date_added === date);
      
      for (const notif of notificationsToDelete) {
        await window.dataSdk.delete(notif);
      }

      closeModal();
      showToast(`All notifications from ${date} deleted`, 'success');
    };

    window.confirmArchiveNotificationsGroup = function(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Archive All</div>
          <div class="modal-text">Archive all ${count} notifications from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="archiveNotificationsGroup('${date}')">Archive All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.archiveNotificationsGroup = async function(date) {
      const itemsToArchive = allNotifications.filter(n => n.date_added === date);
      for (const item of itemsToArchive) {
        await window.dataSdk.update({ ...item, is_archived: true });
      }
      closeModal();
      showToast(`All notifications from ${date} archived`, 'success');
    };

    window.toggleExpirationDateGroup = function(date) {
      const arrow = document.getElementById(`arrow-expiration-${date}`);
      const list = document.getElementById(`list-expiration-${date}`);
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    };

    window.confirmDeleteExpirationGroup = function(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Confirm Delete All</div>
          <div class="modal-text">Are you sure you want to delete all ${count} expired items from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="deleteExpirationGroup('${date}')">Delete All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.deleteExpirationGroup = async function(date) {
      const itemsToDelete = allItems.filter(i => i.date_added === date);
      
      for (const item of itemsToDelete) {
        await window.dataSdk.delete(item);
      }

      closeModal();
      showToast(`All items from ${date} deleted`, 'success');
    };

    window.confirmArchiveExpirationGroup = function(date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Archive All</div>
          <div class="modal-text">Archive all ${count} items from ${formattedDate}?</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="archiveExpirationGroup('${date}')">Archive All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.archiveExpirationGroup = async function(date) {
      const itemsToArchive = allItems.filter(i => i.date_added === date);
      for (const item of itemsToArchive) {
        await window.dataSdk.update({ ...item, is_archived: true });
      }
      closeModal();
      showToast(`All items from ${date} archived`, 'success');
    };

    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ============== ARCHIVE FUNCTIONALITY ==============

    function updateArchiveDisplay() {
      updateStockCountArchive();
      updateEquipmentArchive();
      updateExpiredArchive();
    }

    function updateStockCountArchive() {
      const container = document.getElementById('stockCountArchiveContainer');

      if (archivedStockCounts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <div class="empty-title">No archived stock counts yet</div>
            <div class="empty-subtitle">Stock counts will automatically appear here when you start counting on a new day</div>
          </div>
        `;
        return;
      }

      // Group by date
      const groupedByDate = {};
      archivedStockCounts.forEach(count => {
        const date = count.date_added;
        if (!groupedByDate[date]) {
          groupedByDate[date] = [];
        }
        groupedByDate[date].push(count);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      container.innerHTML = sortedDates.map(date => {
        const counts = groupedByDate[date];
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        return `
          <div class="date-group" data-date="${date}">
            <div class="date-banner" onclick="toggleArchiveDateGroup('stock-${date}')">
              <div class="date-banner-left">
                <span class="expand-arrow" id="arrow-stock-${date}">â–¶</span>
                <span class="date-title">${formattedDate}</span>
                <span class="item-count-badge">${counts.length} entries</span>
              </div>
              <div class="date-banner-actions">
                <button class="btn-save-pdf" onclick="event.stopPropagation(); saveStockCountPDF('${date}')">ğŸ“¥ Save PDF</button>
                <button class="btn-print-pdf" onclick="event.stopPropagation(); printStockCountPDF('${date}')">ğŸ–¨ï¸ Print PDF</button>
                <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteArchiveGroup('stock', '${date}', ${counts.length})">ğŸ—‘ï¸ Delete All</button>
              </div>
            </div>
            <div class="notifications-list" id="list-stock-${date}">
              ${counts.map(count => createStockCountCard(count)).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Attach delete listeners
      archivedStockCounts.forEach(count => {
        const deleteBtn = document.getElementById(`delete-stock-${count.id}`);
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteArchivedStockCount(count));
        }
      });
    }

    function createStockCountCard(count) {
      const icon = categoryIcons[count.item_name] || 'ğŸ“¦';
      const addedDate = new Date(count.added_timestamp).toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });

      return `
        <div class="archive-card">
          <div class="archive-item-main">
            <div class="archive-item-icon">${icon}</div>
            <div class="archive-item-content">
              <div class="archive-item-name">${count.item_name}</div>
              <div class="archive-item-details">
                <div class="archive-item-detail"><strong>Floor:</strong> ${count.floor}</div>
                <div class="archive-item-detail"><strong>Quantity:</strong> ${count.quantity} units</div>
                <div class="archive-item-detail"><strong>Counted:</strong> ${addedDate}</div>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="btn-delete" id="delete-stock-${count.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    async function deleteArchivedStockCount(count) {
      const btn = document.getElementById(`delete-stock-${count.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(count);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete item', 'error');
      }
    }

    function updateEquipmentArchive() {
      const container = document.getElementById('equipmentArchiveContainer');

      if (archivedNotifications.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ› ï¸</div>
            <div class="empty-title">No archived equipment yet</div>
            <div class="empty-subtitle">Archive items from the Notification Center to track equipment history</div>
          </div>
        `;
        return;
      }

      // Group by date
      const groupedByDate = {};
      archivedNotifications.forEach(notif => {
        const date = notif.date_added;
        if (!groupedByDate[date]) {
          groupedByDate[date] = [];
        }
        groupedByDate[date].push(notif);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      container.innerHTML = sortedDates.map(date => {
        const notifications = groupedByDate[date];
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        return `
          <div class="date-group" data-date="${date}">
            <div class="date-banner" onclick="toggleArchiveDateGroup('equipment-${date}')">
              <div class="date-banner-left">
                <span class="expand-arrow" id="arrow-equipment-${date}">â–¶</span>
                <span class="date-title">${formattedDate}</span>
                <span class="item-count-badge">${notifications.length} items</span>
              </div>
              <div class="date-banner-actions">
                <button class="btn-save-pdf" onclick="event.stopPropagation(); saveEquipmentPDF('${date}')">ğŸ“¥ Download Report</button>
                <button class="btn-print-pdf" onclick="event.stopPropagation(); printEquipmentPDF('${date}')">ğŸ–¨ï¸ Print Report</button>
                <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteArchiveGroup('equipment', '${date}', ${notifications.length})">ğŸ—‘      Archive & Delete</button>
              </div>
            </div>
            <div class="notifications-list" id="list-equipment-${date}">
              ${notifications.map(notif => createArchiveEquipmentCard(notif)).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Attach delete listeners
      archivedNotifications.forEach(notif => {
        const deleteBtn = document.getElementById(`delete-archive-notif-${notif.id}`);
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteArchivedNotification(notif));
        }
      });
    }

    function createArchiveEquipmentCard(notif) {
      const icon = notificationIcons[notif.type] || 'ğŸ“';
      const label = notificationLabels[notif.type] || 'Notification';
      const addedDate = new Date(notif.added_timestamp).toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });

      const now = new Date();
      const added = new Date(notif.added_timestamp);
      const daysDiff = Math.floor((now - added) / (1000 * 60 * 60 * 24));
      const ageText = daysDiff === 0 ? 'Today' : daysDiff === 1 ? '1 day' : `${daysDiff} days`;

      return `
        <div class="archive-card">
          <div class="archive-item-main">
            <div class="archive-item-icon">${icon}</div>
            <div class="archive-item-content">
              <div class="archive-item-name">${notif.item_name}</div>
              <div class="archive-item-details">
                <div class="archive-item-detail"><strong>Type:</strong> ${label}</div>
                <div class="archive-item-detail"><strong>Location:</strong> ${notif.location || 'N/A'}</div>
                <div class="archive-item-detail"><strong>Description:</strong> ${notif.description || 'N/A'}</div>
                <div class="archive-item-detail"><strong>Date Reported:</strong> ${addedDate}</div>
                <div class="archive-item-detail"><strong>Age:</strong> ${ageText}</div>
                <div class="archive-item-detail"><strong>Source:</strong> ${notif.source}</div>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="btn-delete" id="delete-archive-notif-${notif.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    function updateExpiredArchive() {
      const container = document.getElementById('expiredArchiveContainer');

      if (archivedItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸŒŸ</div>
            <div class="inspirational-quote">"Quality maintained, standards upheld, excellence delivered."</div>
            <div class="empty-title">No archived items yet</div>
            <div class="empty-subtitle">Items will appear here automatically when you start logging on a new day</div>
          </div>
        `;
        return;
      }

      // Group by date
      const groupedByDate = {};
      archivedItems.forEach(item => {
        const date = item.date_added;
        if (!groupedByDate[date]) {
          groupedByDate[date] = [];
        }
        groupedByDate[date].push(item);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

      container.innerHTML = sortedDates.map(date => {
        const items = groupedByDate[date];
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
        const totalQty = items.reduce((sum, item) => sum + (item.quantity || 0), 0);

        return `
          <div class="date-group" data-date="${date}">
            <div class="date-banner" onclick="toggleArchiveDateGroup('expired-${date}')">
              <div class="date-banner-left">
                <span class="expand-arrow" id="arrow-expired-${date}">  </span>
                <span class="date-title">${formattedDate}</span>
                <span class="item-count-badge">${items.length} items</span>
                <span class="item-count-badge">Total Qty: ${totalQty}</span>
              </div>
              <div class="date-banner-actions">
                <button class="btn-save-pdf" onclick="event.stopPropagation(); saveExpiredPDF('${date}')">ğŸ“¥ Download Report</button>
                <button class="btn-print-pdf" onclick="event.stopPropagation(); printExpiredPDF('${date}')">ğŸ–¨ï¸ Print Report</button>
                <button class="btn-delete-all" onclick="event.stopPropagation(); confirmDeleteArchiveGroup('expired', '${date}', ${items.length})">    ï¸ Archive & Delete</button>
              </div>
            </div>
            <div class="notifications-list" id="list-expired-${date}">
              ${items.map(item => createArchiveExpiredCard(item)).join('')}
            </div>
          </div>
        `;
      }).join('');

      // Attach delete listeners
      archivedItems.forEach(item => {
        const deleteBtn = document.getElementById(`delete-archive-item-${item.id}`);
        if (deleteBtn) {
          deleteBtn.addEventListener('click', () => deleteArchivedItem(item));
        }
      });
    }

    function createArchiveExpiredCard(item) {
      const icon = categoryIcons[item.item_name] || '  ';
      const expDate = new Date(item.expiration_date).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric' 
      });
      const addedDate = new Date(item.added_timestamp).toLocaleString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
      const quantityText = item.quantity ? `${item.quantity} units` : 'N/A';

      return `
        <div class="archive-card expired-item">
          <div class="archive-item-main">
            <div class="archive-item-icon">${icon}</div>
            <div class="archive-item-content">
              <div class="archive-item-name">${item.item_name}</div>
              <div class="archive-item-details">
                <div class="archive-item-detail"><strong>ğŸ“ Location:</strong> ${item.location}</div>
                <div class="archive-item-detail"><strong>ğŸ“¦ Quantity:</strong> ${quantityText}</div>
                <div class="archive-item-detail"><strong>â° Expiration Date:</strong> ${expDate}</div>
                <div class="archive-item-detail"><strong>ğŸ“ Notes:</strong> ${item.notes || 'N/A'}</div>
                <div class="archive-item-detail"><strong>Added:</strong> ${addedDate}</div>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="btn-delete" id="delete-archive-item-${item.id}">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `;
    }

    window.toggleArchiveDateGroup = function(id) {
      const arrow = document.getElementById(`arrow-${id}`);
      const list = document.getElementById(`list-${id}`);
      
      arrow.classList.toggle('expanded');
      list.classList.toggle('expanded');
    };

    async function deleteArchivedNotification(notif) {
      const btn = document.getElementById(`delete-archive-notif-${notif.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(notif);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete item', 'error');
      }
    }

    async function deleteArchivedItem(item) {
      const btn = document.getElementById(`delete-archive-item-${item.id}`);
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>Deleting...';

      const result = await window.dataSdk.delete(item);

      if (!result.isOk) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ—‘ï¸ Delete';
        showToast('Failed to delete item', 'error');
      }
    }

    window.confirmDeleteArchiveGroup = function(type, date, count) {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      let typeLabel = '';
      if (type === 'stock') typeLabel = 'stock count entries';
      else if (type === 'equipment') typeLabel = 'equipment items';
      else typeLabel = 'expired items';

      const warning = `This will permanently delete all ${count} ${typeLabel} from ${formattedDate}. Make sure you've saved the PDF first! This cannot be undone.`;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Delete All ${type === 'stock' ? 'Stock Counts' : type === 'equipment' ? 'Equipment' : 'Expired Items'}?</div>
          <div class="modal-text">${warning}</div>
          <div class="modal-buttons">
            <button class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-modal-confirm" onclick="deleteArchiveGroup('${type}', '${date}')">Yes, Delete All</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.deleteArchiveGroup = async function(type, date) {
      let itemsToDelete = [];
      if (type === 'stock') {
        itemsToDelete = archivedStockCounts.filter(c => c.date_added === date);
      } else if (type === 'equipment') {
        itemsToDelete = archivedNotifications.filter(n => n.date_added === date);
      } else {
        itemsToDelete = archivedItems.filter(i => i.date_added === date);
      }
      
      for (const item of itemsToDelete) {
        await window.dataSdk.delete(item);
      }

      closeModal();
      showToast(`${itemsToDelete.length} items deleted from archive`, 'success');
    };

    // PDF Generation Functions for Stock Counts
    window.saveActiveStockCountPDF = function(date) {
      const counts = allStockCounts.filter(c => c.date_added === date);
      if (counts.length === 0) {
        showToast('No stock counts to save', 'error');
        return;
      }
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Minibar Stock Count (Active) - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      const groupedByItem = {};
      counts.forEach(count => {
        if (!groupedByItem[count.item_name]) {
          groupedByItem[count.item_name] = { F1: 0, F2: 0, F3: 0, Office: 0 };
        }
        groupedByItem[count.item_name][count.floor] += count.quantity;
      });

      Object.keys(groupedByItem).sort().forEach(itemName => {
        const totals = groupedByItem[itemName];
        const total = totals.F1 + totals.F2 + totals.F3 + totals.Office;
        pdfContent += `${itemName}\n`;
        pdfContent += `  F1: ${totals.F1} | F2: ${totals.F2} | F3: ${totals.F3} | Office: ${totals.Office}\n`;
        pdfContent += `  Total: ${total} units\n`;
        pdfContent += 'â€”'.repeat(60) + '\n';
      });

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `minibar-stock-count-active-${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Stock count report downloaded', 'success');
    };

    window.saveStockCountPDF = function(date) {
      const counts = archivedStockCounts.filter(c => c.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Minibar Stock Count Report - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      // Group by item
      const groupedByItem = {};
      counts.forEach(count => {
        if (!groupedByItem[count.item_name]) {
          groupedByItem[count.item_name] = { F1: 0, F2: 0, F3: 0, Office: 0 };
        }
        groupedByItem[count.item_name][count.floor] += count.quantity;
      });

      Object.keys(groupedByItem).sort().forEach(itemName => {
        const totals = groupedByItem[itemName];
        const total = totals.F1 + totals.F2 + totals.F3 + totals.Office;
        
        pdfContent += `${itemName}\n`;
        pdfContent += `  F1: ${totals.F1} | F2: ${totals.F2} | F3: ${totals.F3} | Office: ${totals.Office}\n`;
        pdfContent += `  Total: ${total} units\n`;
        pdfContent += 'â”€'.repeat(60) + '\n';
      });

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Stock_Count_${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Stock count report downloaded', 'success');
    };

    window.printStockCountPDF = function(date) {
      const counts = archivedStockCounts.filter(c => c.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let htmlContent = `
        <html>
        <head>
          <title>Stock Count - ${formattedDate}</title>
          <style>
            @page { margin: 10mm; }
            body { font-family: Arial, sans-serif; padding: 0; font-size: 12px; }
            h1 { color: #0d1b2a; border-bottom: 2px solid #d4af37; padding-bottom: 6px; margin: 0 0 10px; font-size: 16px; }
            .item { margin-bottom: 10px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; }
            .item-name { font-size: 13px; font-weight: bold; color: #d4af37; margin-bottom: 4px; }
            .detail { margin: 3px 0; }
            .label { font-weight: bold; }
          </style>
        </head>
        <body>
          <h1>Minibar Stock Count Report - ${formattedDate}</h1>
      `;

      // Group by item
      const groupedByItem = {};
      counts.forEach(count => {
        if (!groupedByItem[count.item_name]) {
          groupedByItem[count.item_name] = { F1: 0, F2: 0, F3: 0, Office: 0 };
        }
        groupedByItem[count.item_name][count.floor] += count.quantity;
      });

      Object.keys(groupedByItem).sort().forEach(itemName => {
        const totals = groupedByItem[itemName];
        const total = totals.F1 + totals.F2 + totals.F3 + totals.Office;
        
        htmlContent += `
          <div class="item">
            <div class="item-name">${itemName}</div>
            <div class="detail"><span class="label">F1:</span> ${totals.F1} | <span class="label">F2:</span> ${totals.F2} | <span class="label">F3:</span> ${totals.F3} | <span class="label">Office:</span> ${totals.Office}</div>
            <div class="detail"><span class="label">Total:</span> ${total} units</div>
          </div>
        `;
      });

      htmlContent += `
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.print();
    };

    // PDF Generation Functions for Equipment
    window.saveEquipmentPDF = function(date) {
      const items = archivedNotifications.filter(n => n.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Housekeeping Equipment Report - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      items.forEach(item => {
        const addedDate = new Date(item.added_timestamp).toLocaleString('en-US');
        const now = new Date();
        const added = new Date(item.added_timestamp);
        const daysDiff = Math.floor((now - added) / (1000 * 60 * 60 * 24));
        const ageText = daysDiff === 0 ? 'Today' : daysDiff === 1 ? '1 day' : `${daysDiff} days`;

        pdfContent += `Item Name: ${item.item_name}\n`;
        pdfContent += `Type: ${notificationLabels[item.type]}\n`;
        pdfContent += `Location: ${item.location || 'N/A'}\n`;
        pdfContent += `Description: ${item.description || 'N/A'}\n`;
        pdfContent += `Date Reported: ${addedDate}\n`;
        pdfContent += `Age: ${ageText}\n`;
        pdfContent += `Source: ${item.source}\n`;
        pdfContent += 'â”€'.repeat(60) + '\n\n';
      });

      pdfContent += `\nTotal Equipment Items: ${items.length}\n`;

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Equipment_Report_${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('PDF report downloaded', 'success');
    };

    window.saveActiveExpirationPDF = function(date) {
      const items = allItems.filter(i => i.date_added === date);
      if (items.length === 0) {
        showToast('No items to save', 'error');
        return;
      }
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Expiration Control (Active) - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      items.forEach(item => {
        const expDate = new Date(item.expiration_date).toLocaleDateString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric'
        });
        pdfContent += `Item: ${item.item_name}\n`;
        pdfContent += `  Location: ${item.location || 'N/A'}\n`;
        pdfContent += `  Quantity: ${item.quantity || 'N/A'}\n`;
        pdfContent += `  Expiration: ${expDate}\n`;
        pdfContent += `  Notes: ${item.notes || 'N/A'}\n`;
        pdfContent += 'â€”'.repeat(60) + '\n';
      });

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `expiration-active-${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Expiration report downloaded', 'success');
    };

    window.saveActiveNotificationsPDF = function(date) {
      const items = allNotifications.filter(n => n.date_added === date);
      if (items.length === 0) {
        showToast('No notifications to save', 'error');
        return;
      }
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Notifications (Active) - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      items.forEach(notif => {
        const addedDate = new Date(notif.added_timestamp).toLocaleString('en-US', {
          year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        pdfContent += `Type: ${notificationLabels[notif.type] || notif.type}\n`;
        pdfContent += `  Item: ${notif.item_name || 'N/A'}\n`;
        pdfContent += `  Location: ${notif.location || 'N/A'}\n`;
        pdfContent += `  Description: ${notif.description || 'N/A'}\n`;
        pdfContent += `  Source: ${notif.source || 'N/A'}\n`;
        pdfContent += `  Added: ${addedDate}\n`;
        pdfContent += 'â€”'.repeat(60) + '\n';
      });

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `notifications-active-${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Notifications report downloaded', 'success');
    };

    window.printEquipmentPDF = function(date) {
      const items = archivedNotifications.filter(n => n.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let htmlContent = `
        <html>
        <head>
          <title>Equipment Report - ${formattedDate}</title>
          <style>
            @page { size: A4; margin: 6mm; }
            body { font-family: Arial, sans-serif; padding: 0; font-size: 9px; line-height: 1.2; }
            h1 { color: #0d1b2a; margin: 0 0 6px; font-size: 12px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 2px 4px; text-align: left; vertical-align: top; }
            th { background: #f4f4f4; font-weight: 700; }
          </style>
        </head>
        <body>
          <h1>Equipment Report - ${formattedDate}</h1>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Type</th>
                <th>Location</th>
                <th>Description</th>
                <th>Date</th>
                <th>Age</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody>
      `;

      items.forEach(item => {
        const addedDate = new Date(item.added_timestamp).toLocaleString('en-US');
        const now = new Date();
        const added = new Date(item.added_timestamp);
        const daysDiff = Math.floor((now - added) / (1000 * 60 * 60 * 24));
        const ageText = daysDiff === 0 ? 'Today' : daysDiff === 1 ? '1 day' : `${daysDiff} days`;

        htmlContent += `
          <tr>
            <td>${item.item_name}</td>
            <td>${notificationLabels[item.type] || item.type}</td>
            <td>${item.location || 'N/A'}</td>
            <td>${item.description || 'N/A'}</td>
            <td>${addedDate}</td>
            <td>${ageText}</td>
            <td>${item.source || 'N/A'}</td>
          </tr>
        `;
      });

      htmlContent += `
            </tbody>
          </table>
          <p style="margin-top: 6px; font-weight: bold;">Total Equipment Items: ${items.length}</p>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.print();
    };

    window.saveExpiredPDF = function(date) {
      const items = archivedItems.filter(i => i.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let pdfContent = `Expired Items Report - ${formattedDate}\n`;
      pdfContent += '='.repeat(60) + '\n\n';

      items.forEach(item => {
        const expDate = new Date(item.expiration_date).toLocaleDateString('en-US', { 
          year: 'numeric', month: 'short', day: 'numeric' 
        });
        const quantityText = item.quantity ? `${item.quantity} units` : 'N/A';

        pdfContent += `Item Name: ${item.item_name}\n`;
        pdfContent += `Expiration Date: ${expDate}\n`;
        pdfContent += `Location: ${item.location}\n`;
        pdfContent += `Quantity: ${quantityText}\n`;
        pdfContent += `Notes: ${item.notes || 'Found during routine check'}\n`;
        pdfContent += 'â”€'.repeat(60) + '\n\n';
      });

      const totalQty = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
      pdfContent += `\nTotal Items: ${items.length}\n`;
      pdfContent += `Total Quantity: ${totalQty} units\n`;

      const blob = new Blob([pdfContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Expired_Items_${date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('PDF report downloaded', 'success');
    };

    window.printExpiredPDF = function(date) {
      const items = archivedItems.filter(i => i.date_added === date);
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let htmlContent = `
        <html>
        <head>
          <title>Expired Items Report - ${formattedDate}</title>
          <style>
            @page { size: A4; margin: 6mm; }
            body { font-family: Arial, sans-serif; padding: 0; font-size: 9px; line-height: 1.2; }
            h1 { color: #0d1b2a; margin: 0 0 6px; font-size: 12px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 2px 4px; text-align: left; vertical-align: top; }
            th { background: #f4f4f4; font-weight: 700; }
          </style>
        </head>
        <body>
          <h1>Expired Items Report - ${formattedDate}</h1>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Expiration</th>
                <th>Location</th>
                <th>Qty</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
      `;

      items.forEach(item => {
        const expDate = new Date(item.expiration_date).toLocaleDateString('en-US', { 
          year: 'numeric', month: 'short', day: 'numeric' 
        });
        const quantityText = item.quantity ? `${item.quantity} units` : 'N/A';

        htmlContent += `
          <tr>
            <td>${item.item_name}</td>
            <td>${expDate}</td>
            <td>${item.location}</td>
            <td>${quantityText}</td>
            <td>${item.notes || 'Found during routine check'}</td>
          </tr>
        `;
      });

      const totalQty = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
      htmlContent += `
            </tbody>
          </table>
          <p style="margin-top: 6px; font-weight: bold;">Total Items: ${items.length} | Total Quantity: ${totalQty} units</p>
        </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.print();
    };

    async function onConfigChange(config) {
      const mainTitle = document.getElementById('mainTitle');
      const footerCopy = document.getElementById('footerCopy');

      mainTitle.textContent = config.main_title || defaultConfig.main_title;
      if (footerCopy) footerCopy.textContent = config.footer_text || defaultConfig.footer_text;
    }

    async function updateFooterVersion() {
      const versionEl = document.getElementById('footerVersion');
      const buildBadge = document.getElementById('buildBadge');
      if (!versionEl) return;
      try {
        const response = await fetch(
          'https://api.github.com/repos/maarja52-stack/housekeeping-stock-/commits?per_page=1',
          { cache: 'no-store' }
        );
        const link = response.headers.get('link') || '';
        const match = link.match(/&page=(\d+)>; rel="last"/);
        let count = match ? parseInt(match[1], 10) : 1;
        const body = await response.json();
        const sha = body && body[0] && body[0].sha ? body[0].sha.slice(0, 7) : '';
        if (!Number.isFinite(count)) count = 1;
        const versionText = `v${count}${sha ? ` (${sha})` : ''}`;
        versionEl.textContent = versionText;
        if (buildBadge) buildBadge.textContent = `Build ${versionText}`;
      } catch (err) {
        versionEl.textContent = 'vâ€”';
        if (buildBadge) buildBadge.textContent = 'Build vâ€”';
      }
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["footer_text", config.footer_text || defaultConfig.footer_text]
      ]);
    }

    // Initialize everything
    initializeDataSDK();
    updateFooterVersion();

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 </body>
</html>
